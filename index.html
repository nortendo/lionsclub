
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lions Club La Louvière - Relais pour la Vie</title>
  <style>
    :root { --orange:#ff7a18; --purple:#5B5FEF; --muted:#666; }
    body{margin:0;font-family:Inter,Arial,sans-serif;background:linear-gradient(120deg,#5B5FEF,#9C27B0);min-height:100vh;}
    .wrap{max-width:1120px;margin:40px auto;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden}
    header{padding:22px 24px;background:linear-gradient(90deg,var(--orange),#ff3d00);color:#fff;font-weight:800;font-size:32px;text-shadow:0 2px 6px rgba(0,0,0,.25)}
    .sub{padding:0 24px 16px;color:#ffe;opacity:.95}
    .tabs{display:flex;border-bottom:1px solid #eee;background:#fafafa}
    .tab-button{flex:1;border:0;border-bottom:3px solid transparent;padding:12px 16px;background:#fafafa;cursor:pointer;font-weight:700}
    .tab-button.active{border-color:var(--purple);background:#fff;color:var(--purple)}
    main{padding:18px}
    .row{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
    .card{border:1px solid #eee;border-radius:12px;padding:12px 14px}
    .stats{display:grid;gap:12px;grid-template-columns:repeat(4,minmax(0,1fr));}
    .stat-card{border:1px solid #eee;border-radius:12px;padding:14px}
    .stat-title{font-weight:700;color:#333;margin-bottom:6px}
    .stat-value{font-size:28px;font-weight:800}
    .pill{display:inline-block;background:#eef;border:1px solid #dde;border-radius:999px;padding:2px 8px;margin-left:6px;font-size:12px}
    .muted{color:var(--muted);font-size:12px}
    .hidden{display:none}
    .posrow{display:flex; gap:8px; align-items:center; margin:6px 0;}
    .posrow label{width:60px; color:#555;}
    select,button{border:1px solid #ddd;border-radius:8px;padding:8px 10px}
    button.action{background:var(--purple);color:#fff;font-weight:700;cursor:pointer}
    button.action.secondary{background:#e0e0ff;color:#333}
    table{width:100%; border-collapse:collapse; margin:10px 0; font-size:14px}
    th,td{border:1px solid #e9e9e9; padding:8px 10px; text-align:left}
    th{background:#fafafa}
    .list{margin-top:10px;max-height:280px;overflow:auto;border:1px dashed #ddd;border-radius:10px;padding:10px}
    .list a{display:inline-block;margin:4px 6px;text-decoration:none;background:#f6f6ff;border:1px solid #ddd;padding:4px 8px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>🏃 Lions Club La Louvière - Relais pour la Vie</header>
    <div class="sub">La Louvière • 11-12 Octobre 2025</div>
    <div class="tabs">
      <button class="tab-button active" onclick="switchTab('tshirts')">👕 Tailles T‑Shirts</button>
      <button class="tab-button" onclick="switchTab('planning')">🗓️ Planning Marche</button>
      <button class="tab-button" onclick="switchTab('resume')">📊 Résumé</button>
    </div>
    <main>
      <section id="tshirts" class="tab-content">
        <h3>Sélection des tailles</h3>
        <div class="row" id="tshirtsBox"></div>
      </section>

      <section id="planning" class="tab-content hidden">
        <h3>Réserver un créneau (2 pers / créneau, modifiable)</h3>
        <p class="muted">Tu peux ajouter une personne sur une position libre et <b>Retirer</b> quelqu’un si besoin.</p>
        <div class="row" id="slotsBox"></div>
      </section>

      <section id="resume" class="tab-content hidden">
        <h3>Résumé de l'organisation</h3>
        <div class="stats">
          <div class="stat-card">
            <div class="stat-title">📝 À compléter</div>
            <div class="stat-value" id="missingBothCount">0</div>
            <div class="muted">sans T‑shirt & ni créneau</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">👕 T‑Shirts choisis</div>
            <div class="stat-value" id="k2">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">🗓️ Créneaux réservés</div>
            <div class="stat-value" id="k3">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">✅ Créneaux dispo</div>
            <div class="stat-value" id="k4">0</div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <a id="showTshirts" style="cursor:pointer; color:#5B5FEF; text-decoration:underline; margin-right:12px;">👕 Voir détails T‑Shirts</a>
          <a id="showSlots" style="cursor:pointer; color:#5B5FEF; text-decoration:underline;">🗓️ Voir détails créneaux réservés</a>
        </div>

        <div id="tshirtsDetails" class="hidden">
          <h4>👕 Détails T‑Shirts par personne</h4>
          <table id="tblTshirts">
            <thead><tr><th>Nom</th><th>Taille</th></tr></thead>
            <tbody></tbody>
          </table>
          <h5>Répartition par tailles</h5>
          <div id="sizesBreak"></div>
        </div>

        <div id="slotsDetails" class="hidden">
          <h4>🗓️ Détails créneaux réservés</h4>
          <table id="tblSlots">
            <thead><tr><th>Créneau</th><th>Personne 1</th><th>Personne 2</th><th>État</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <h4 style="margin-top:18px;">🔒 Créneaux déjà pris</h4>
        <div id="listTaken" class="list"></div>
        <h4 style="margin-top:18px;">✅ Créneaux disponibles</h4>
        <div id="listFree" class="list"></div>
      </section>
    </main>
  </div>

  <script>
    function switchTab(id){
      document.querySelectorAll('.tab-content').forEach(s=>s.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
      const btn = Array.from(document.querySelectorAll('.tab-button')).find(b=>b.getAttribute('onclick').includes(id));
      if(btn) btn.classList.add('active');
    }

    const MEMBERS = ["Yvan D","Michelina C","Pasquale D","Enora D","Véronique L","Sandy","Manuela","Christophe G","Pino D","Malika Z","Nolann D","Irina","Le fils de Sandy","Le fils de Manuela","Cyril G","Mario D","Olivier D","Aurore V","Sabrina","Yves E"];

    function genSlots(){
      const start = new Date(2025, 9, 11, 15, 0, 0);
      const end   = new Date(2025, 9, 12, 15, 0, 0);
      const slots = [];
      for(let t = new Date(start); t < end; t = new Date(t.getTime() + 30*60*1000)){
        const t2 = new Date(t.getTime() + 30*60*1000);
        const dow = t.getDay();
        const pfx = (dow===6? 'sam' : 'dim');
        const fmt = (d)=> d.toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit',hour12:false});
        slots.push(`${pfx} ${fmt(t)}-${fmt(t2)}`);
      }
      return slots;
    }
    const SLOTS = genSlots();

    async function getState(){ const r = await fetch('/api/state-get'); return r.json(); }
    async function setTshirt(name,size,email=""){
      const r = await fetch('/api/state-set-tshirt',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({name,size,email})});
      return r.json();
    }
    async function clearTshirt(name){
      const r = await fetch('/api/state-set-tshirt',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({name, clear:true})});
      return r.json();
    }
    async function setSlot(slotId,name){
      const r = await fetch('/api/state-set-slot',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({slotId,name})});
      return r.json();
    }
    async function unsetSlot(slotId,name){
      const r = await fetch('/api/state-unset-slot',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({slotId,name})});
      return r.json();
    }

    function renderTshirts(state){
      const box = document.getElementById('tshirtsBox'); box.innerHTML='';
      const sizes = ["XS","S","M","L","XL","XXL"];
      MEMBERS.forEach(m=>{
        const div = document.createElement('div'); div.className='card';
        const current = state.tshirtData?.[m] || "";
        const title = document.createElement('div');
        title.innerHTML = `<strong>${m}</strong>` + (current ? ` <span class="pill">${current}</span>` : '');
        div.appendChild(title);

        const sel = document.createElement('select');
        const ph = document.createElement('option'); ph.value=""; ph.textContent="-- Choisir une taille --"; sel.appendChild(ph);
        sizes.forEach(s=>{ const o=document.createElement('option'); o.value=s;o.textContent=s; sel.appendChild(o); });
        sel.value = current;

        const save = async ()=>{
          if(!sel.value) return;
          await setTshirt(m, sel.value);
          await load();
        };
        sel.addEventListener('change', save);
        if (current) sel.disabled = true;

        const actions = document.createElement('div'); actions.style.marginTop='8px';
        const btnEdit = document.createElement('button'); btnEdit.textContent = current ? 'Modifier' : 'Enregistrer'; btnEdit.className='action';
        btnEdit.onclick = async ()=>{
          if (!current) { await save(); }
          else { sel.disabled = false; sel.focus(); }
        };
        const btnClear = document.createElement('button'); btnClear.textContent = 'Effacer'; btnClear.className='action secondary'; btnClear.style.marginLeft='6px';
        btnClear.onclick = async ()=>{ await clearTshirt(m); await load(); };

        div.appendChild(sel);
        div.appendChild(actions);
        actions.appendChild(btnEdit);
        actions.appendChild(btnClear);
        box.appendChild(div);
      });
    }

    function cssId(s){ return s.replace(/[^a-z0-9]+/gi,'-'); }

    function renderSlots(state){
      const box = document.getElementById('slotsBox'); box.innerHTML='';
      SLOTS.forEach(id=>{
        const div = document.createElement('div'); div.className='card'; div.id = `slot-${cssId(id)}`;
        const takenArr = (state.scheduleData?.[id]||[]);
        const spotsLeft = Math.max(0, 2 - takenArr.length);
        const takenTxt = takenArr.join(', ') || '—';
        div.innerHTML = `<strong>${id}</strong><span class="pill">${spotsLeft} place(s) restante(s)</span><div class="muted">Occupé: ${takenTxt}</div>`;

        for(let pos=0; pos<2; pos++){
          const row = document.createElement('div'); row.className='posrow';
          const label = document.createElement('label'); label.textContent = `Pers. ${pos+1}`;
          const current = takenArr[pos] || "";

          if (current) {
            const nameSpan = document.createElement('span'); nameSpan.textContent = current;
            const btnFree = document.createElement('button'); btnFree.textContent='Retirer'; btnFree.className='action secondary';
            btnFree.onclick = async ()=>{ await unsetSlot(id, current); await load(); };
            row.appendChild(label); row.appendChild(nameSpan); row.appendChild(btnFree);
          } else {
            const sel = document.createElement('select');
            const ph = document.createElement('option'); ph.value=""; ph.textContent="-- Choisir une personne --"; sel.appendChild(ph);
            MEMBERS.forEach(m=>{ const o=document.createElement('option'); o.value=m;o.textContent=m; sel.appendChild(o); });
            const btn = document.createElement('button'); btn.textContent='Réserver'; btn.className='action'; btn.disabled = true;
            sel.addEventListener('change', ()=>{ btn.disabled = !sel.value; });
            btn.onclick = async ()=>{ if(!sel.value) return; await setSlot(id, sel.value); await load(); };
            row.appendChild(label); row.appendChild(sel); row.appendChild(btn);
          }
          div.appendChild(row);
        }
        box.appendChild(div);
      });
    }

    function renderSummary(state){
      const taken = [], free = [];
      SLOTS.forEach(id => {
        const n = (state.scheduleData?.[id]||[]).length;
        if (n > 0) taken.push(id);
        if (n < 2) free.push(id);
      });

      document.getElementById('k2').textContent = Object.keys(state.tshirtData||{}).length;
      document.getElementById('k3').textContent = SLOTS.reduce((a,id)=>a + ((state.scheduleData?.[id]||[]).length), 0);
      document.getElementById('k4').textContent = free.length;

      const listTaken = document.getElementById('listTaken'); listTaken.innerHTML='';
      taken.forEach(id=>{
        const a = document.createElement('a'); a.href = `#slot-${cssId(id)}`; a.textContent = id;
        a.onclick = ()=>{ switchTab('planning'); setTimeout(()=>{ document.getElementById(`slot-${cssId(id)}`)?.scrollIntoView({behavior:'smooth',block:'center'}); },50); };
        listTaken.appendChild(a);
      });
      const listFree = document.getElementById('listFree'); listFree.innerHTML='';
      free.forEach(id=>{
        const a = document.createElement('a'); a.href = `#slot-${cssId(id)}`; a.textContent = id;
        a.onclick = ()=>{ switchTab('planning'); setTimeout(()=>{ document.getElementById(`slot-${cssId(id)}`)?.scrollIntoView({behavior:'smooth',block:'center'}); },50); };
        listFree.appendChild(a);
      });

      // --- Détails T-shirts
      document.getElementById('showTshirts').onclick = ()=>{
        document.getElementById('tshirtsDetails').classList.toggle('hidden');
      };
      // --- Détails créneaux
      document.getElementById('showSlots').onclick = ()=>{
        document.getElementById('slotsDetails').classList.toggle('hidden');
      };

      // T-shirts table
      const tbodyT = document.querySelector('#tblTshirts tbody'); tbodyT.innerHTML='';
      const sizesCount = {};
      Object.entries(state.tshirtData||{}).forEach(([name,size])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${name}</td><td>${size}</td>`;
        tbodyT.appendChild(tr);
        sizesCount[size] = (sizesCount[size] || 0) + 1;
      });
      const sizesBreak = document.getElementById('sizesBreak'); sizesBreak.innerHTML='';
      Object.keys(sizesCount).sort().forEach(s=>{
        const b = document.createElement('span'); b.className='pill'; b.textContent = `${sizesCount[s]}× ${s}`;
        sizesBreak.appendChild(b);
      });

      // Slots details
      const tbodyS = document.querySelector('#tblSlots tbody'); tbodyS.innerHTML='';
      SLOTS.forEach(id=>{
        const arr = state.scheduleData?.[id]||[];
        if (arr.length>0){
          const tr = document.createElement('tr');
          const p1 = arr[0] || '—';
          const p2 = arr[1] || '—';
          const etat = (arr.length===2) ? 'Complet' : '1 place restante';
          tr.innerHTML = `<td>${id}</td><td>${p1}</td><td>${p2}</td><td>${etat}</td>`;
          tbodyS.appendChild(tr);
        }
      });

      // ---- À compléter (sans T-shirt ET sans créneau) ----
      const withTshirt = new Set(Object.keys(state.tshirtData||{}));
      const withSlot = new Set();
      Object.values(state.scheduleData||{}).forEach(arr => {
        (arr||[]).forEach(n => withSlot.add(n));
      });
      const missingTshirt = MEMBERS.filter(n => !withTshirt.has(n));
      const missingSlot   = MEMBERS.filter(n => !withSlot.has(n));
      const missingBoth   = MEMBERS.filter(n => !withTshirt.has(n) && !withSlot.has(n));

      const setText = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
      setText('missingBothCount', missingBoth.length);

      function renderList(id, arr){
        const ul = document.getElementById(id);
        if (!ul) return;
        ul.innerHTML = arr.length ? arr.map(n => `<li>${n}</li>`).join('') : '<li><i>Personne 🎉</i></li>';
      }

      // Injecte (ou crée) le panneau de détails sous Résumé
      if (!document.getElementById('missing-details-panel')) {
        const panel = document.createElement('div');
        panel.className='card'; panel.id='missing-details-panel'; panel.style.marginTop='16px';
        panel.innerHTML = `
          <h3>🚦 Personnes à compléter</h3>
          <details open>
            <summary><b>Sans T‑shirt <i>et</i> sans créneau</b> (<span id="missingBothCountInline">0</span>)</summary>
            <ul id="list-missing-both" style="margin-top:6px"></ul>
          </details>
          <details>
            <summary><b>Sans T‑shirt</b> (<span id="missingTshirtCount">0</span>)</summary>
            <ul id="list-missing-tshirt" style="margin-top:6px"></ul>
          </details>
          <details>
            <summary><b>Sans créneau</b> (<span id="missingSlotCount">0</span>)</summary>
            <ul id="list-missing-slot" style="margin-top:6px"></ul>
          </details>
        `;
        document.getElementById('resume').appendChild(panel);
      }
      setText('missingBothCountInline', missingBoth.length);
      setText('missingTshirtCount', missingTshirt.length);
      setText('missingSlotCount',   missingSlot.length);
      renderList('list-missing-both',   missingBoth);
      renderList('list-missing-tshirt', missingTshirt);
      renderList('list-missing-slot',   missingSlot);
    }

    async function load(){
      const state = await getState();
      renderTshirts(state);
      renderSlots(state);
      renderSummary(state);
    }
    load(); setInterval(load, 10000);
  </script>
</body>
</html>
