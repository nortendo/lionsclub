<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lions Club La Louvi√®re - Relais pour la Vie - Merci</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(45deg, #ff6b6b, #ffa500); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.2rem; opacity: 0.9; }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #dee2e6; }
        .tab { flex: 1; padding: 15px 20px; text-align: center; cursor: pointer; border: none; background: none; font-size: 1.1rem; font-weight: 600; color: #6c757d; transition: all 0.3s ease; }
        .tab.active { background: white; color: #495057; border-bottom: 3px solid #ff6b6b; }
        .tab:hover:not(.active) { background: #e9ecef; color: #495057; }
        .content { padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tshirt-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .member-card { background: #f8f9fa; border-radius: 10px; padding: 20px; border: 2px solid #e9ecef; transition: all 0.3s ease; }
        .member-card:hover { border-color: #ff6b6b; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .member-name { font-weight: bold; font-size: 1.1rem; color: #495057; margin-bottom: 10px; }
        .size-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
        .size-btn { padding: 8px 12px; border: 2px solid #dee2e6; background: white; border-radius: 20px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; min-width: 45px; text-align: center; }
        .size-btn:hover { border-color: #ff6b6b; background: #fff5f5; }
        .size-btn.selected { background: #ff6b6b; color: white; border-color: #ff6b6b; }
        .schedule-container { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .day-header { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center; font-size: 1.3rem; font-weight: bold; }
        .time-slots { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 10px; }
        .time-slot { background: white; border: 2px solid #dee2e6; border-radius: 8px; padding: 12px; transition: all 0.2s ease; }
        .time-slot:hover { border-color: #28a745; background: #f8fff9; }
        .time-slot.assigned { border-color: #28a745; background: #d4edda; }
        .time-range { font-weight: bold; font-size: 1rem; color: #495057; margin-bottom: 5px; }
        .assigned-to { font-size: 0.9rem; color: #155724; font-weight: 600; display: flex; flex-direction: column; gap: 6px; }
        .member-select { width: 100%; padding: 5px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem; }
        .chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; background: #20c997; color: white; border-radius: 999px; font-size: 0.85rem; }
        .chip button { background: rgba(0,0,0,0.15); border: none; color: white; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; }
        .summary { background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .summary h3 { margin-bottom: 15px; font-size: 1.3rem; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .summary-item { text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; }
        .summary-number { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
        .export-btn, .submit-btn { background: linear-gradient(45deg, #007bff, #0056b3); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; margin: 10px 5px; transition: all 0.3s ease; }
        .export-btn:hover, .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,123,255,0.4); }
        .form-row { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 10px; }
        .form-row label { font-weight: 600; color: #495057; }
        .form-row input { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 8px; font-size: 1rem; }
        .hp { display: none; visibility: hidden; }
        .toolbar { display:flex; gap:10px; align-items:center; margin-bottom:12px;}
        .toast { position: fixed; bottom: 24px; right: 24px; background: #212529; color: white; padding: 12px 16px; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.25); opacity: 0; transform: translateY(10px); transition: all .25s ease; pointer-events: none;}
        .toast.show { opacity: 1; transform: translateY(0); }
        /* Modal */
        #slotsModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; }
        #slotsModal .panel { background:white; padding:20px; border-radius:10px; max-width:700px; width:92%; max-height:80vh; overflow:auto; }
        #slotsList button { border:none; padding:6px 10px; border-radius:8px; background:#e9ecef; cursor:pointer; margin:4px 0; text-align:left; width:100%; }
        #slotsList button:hover { background:#dee2e6; }
        .highlight { animation: flash 1s ease-in-out 2; }
        @keyframes flash { 0%{box-shadow:0 0 0 0 rgba(40,167,69,0.8)} 50%{box-shadow:0 0 0 6px rgba(40,167,69,0.25)} 100%{box-shadow:0 0 0 0 rgba(40,167,69,0)} }
        @media (max-width: 768px) { .header h1 { font-size: 2rem; } .tabs { flex-direction: column; } .content { padding: 20px; } .tshirt-grid { grid-template-columns: 1fr; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö∂‚Äç‚ôÇÔ∏è Lions Club La Louvi√®re - Relais pour la Vie</h1>
            <p>La Louvi√®re ‚Ä¢ 11-12 Octobre 2025</p>
        </div>

        <div id="errorBanner" style="display:none; margin:12px 24px 0; padding:10px 14px; border-radius:10px; background:#fff3cd; border:1px solid #ffeeba; color:#5c4f00; font-weight:600;"></div>
        <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'tshirts')">üëï Tailles T-Shirts</button>
            <button class="tab" onclick="switchTab(event, 'schedule')">‚è∞ Planning Marche</button>
            <button class="tab" onclick="switchTab(event, 'summary')">üìä R√©sum√©</button>
        </div>

        <div class="content">
            <div id="tshirts" class="tab-content active">
                <h2 style="margin-bottom: 20px; color: #495057;">S√©lection des tailles de t-shirts</h2>
                <div class="tshirt-grid" id="tshirtGrid"></div>
</div>

            <div id="schedule" class="tab-content">
                <div class="toolbar">
                    <label for="filterMember">Filtrer par membre :</label>
                    <select id="filterMember" class="member-select" style="max-width:280px" onchange="createSchedule()">
                        <option value="">-- Tous les membres --</option>
                    </select>
                </div>
                <h2 style="margin-bottom: 12px; color: #495057;">Planning des cr√©neaux de marche (jusqu'√† 2 personnes / cr√©neau)</h2>
                <div id="scheduleContainer"></div>
</div>

            <div id="summary" class="tab-content">
                <div class="summary">
                    <h3>üìà R√©sum√© de l'organisation</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-number" id="totalMembers">0</div>
                            <div>Membres</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number" id="tshirtsSelected" onclick="showTshirtSelections()" style="cursor:pointer; text-decoration:underline;">0</div>
                            <div>T-shirts s√©lectionn√©s (cliquer)</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number" id="slotsAssigned" onclick="showAssignedSlots()" style="cursor:pointer; text-decoration:underline;">0</div>
                            <div>Cr√©neaux assign√©s (cliquer)</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number" id="slotsFree" onclick="showFreeSlots()" style="cursor:pointer; text-decoration:underline;">0</div>
                            <div>Cr√©neaux libres (cliquer)</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number" id="totalSlots">0</div>
                            <div>Cr√©neaux totaux</div>
                        </div>
                    </div>
                </div>

                <!-- Netlify form -->
                <form name="RelaisVieInscription" method="POST" data-netlify="true" netlify-honeypot="bot-field" action="/merci" onsubmit="prepareNetlifyPayload()" onsubmit="prepareNetlifyPayload()">
                    <input type="hidden" name="form-name" value="RelaisVieInscription">
                    <noscript><p style="color:#dc3545; font-weight:600;">Activez JavaScript pour envoyer le formulaire.</p></noscript>
                    <div class="hp" aria-hidden="true">
                        <label>Ne pas remplir si tu es humain: <input name="bot-field" /></label>
                    </div>

                    <div class="form-row">
                        <div>
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" placeholder="ton@email.com" required>
                        </div>
                    </div>

                    <!-- Hidden Netlify payload -->
                    <textarea id="tshirtDataField" name="tshirtData" hidden></textarea>
                    <textarea id="scheduleDataField" name="scheduleData" hidden></textarea>
                    <textarea id="membersField" name="members" hidden></textarea>

                    <button type="submit" class="submit-btn" type="submit" >üì® Envoyer toutes les infos</button>
<p style="margin-top:10px; font-size:0.95rem; color:#495057; background:#fff3cd; border:1px solid #ffeeba; padding:10px; border-radius:8px;">
‚ö†Ô∏è Si vous ne cliquez pas sur ce bouton, vos informations (tailles & cr√©neaux) ne seront pas enregistr√©es.<br>
üôè Merci pour votre participation !
</p>

                </form>
</div>
        </div>
    </div>

    <!-- Modal for assigned/free slots -->
    <div id="slotsModal" onclick="closeModalOnBackdrop(event)">
        <div class="panel">
            <h3 id="slotsModalTitle">Cr√©neaux</h3>
            <div id="slotsList" style="margin-top:10px;"></div>
            <div style="display:flex; gap:8px; margin-top:14px; justify-content:flex-end;">
                <button onclick="document.getElementById('slotsModal').style.display='none'">Fermer</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
    (async function(){
        const members = [
            'Yvan D','Christophe G','Cyril G','Michelina C','Pino D','Mario D',
            'Pasquale D','Malika Z','Olivier D','Enora D','Nolann D','Aurore V',
            'Veronique L','Irina','Sabrina','Sandy','Le fils de Sandy','Yves E',
            'Manuela','Le fils de Manuela','Sandy L'
        ];
        const sizes = ['XS','S','M','L','XL','XXL'];
        let tshirtData = {};
        let scheduleData = {}; // { slotId: [membre1?, membre2?] }

        // init
        members.forEach(m => { tshirtData[m] = null; });
        function initFilter() {
            const sel = document.getElementById('filterMember');
            sel.innerHTML = '<option value="">-- Tous les membres --</option>' + members.map(m => `<option value="${m}">${m}</option>`).join('');
        }

        function switchTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.target.classList.add('active');
            if (tabName === 'summary') updateSummary();
        }

        // T-SHIRTS
        function createTshirtGrid() {
            const grid = document.getElementById('tshirtGrid');
            grid.innerHTML = '';
            members.forEach(member => {
                const card = document.createElement('div');
                card.className = 'member-card';
                const sizeButtons = sizes.map(size => 
                    `<button class="size-btn ${tshirtData[member] === size ? 'selected' : ''}" onclick="selectSize('${member}','${size}')">${size}</button>`
                ).join('');
                card.innerHTML = `<div class="member-name">${member}</div><div class="size-buttons">${sizeButtons}</div>`;
                grid.appendChild(card);
            });
        }
        function selectSize(member, size) {
            const newVal = (tshirtData[member] === size ? null : size);
            tshirtData[member] = newVal;
            apiSetTshirt(member, newVal).then(async ()=>{
                await fetchState();
                createTshirtGrid();
                updateSummary();
                showToast('Taille mise √† jour');
            }).catch(()=>showToast('Erreur de sauvegarde (r√©essaie)'));
        }

        // SCHEDULE
        function generateTimeSlots() {
            const slots = [];
            const startDate = new Date('2025-10-11T15:00:00');
            const endDate = new Date('2025-10-12T15:00:00');
            let current = new Date(startDate);
            while (current < endDate) {
                const next = new Date(current.getTime() + 30 * 60000);
                const dayKey = current.toDateString();
                if (!slots.find(day => day.date === dayKey)) {
                    slots.push({
                        date: dayKey,
                        day: current.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' }),
                        slots: []
                    });
                }
                const daySlots = slots.find(day => day.date === dayKey);
                daySlots.slots.push({
                    id: `${current.getTime()}`,
                    startDate: new Date(current),
                    endDate: new Date(next)
                });
                current = next;
            }
            return slots;
        }

        function createSchedule() {
            const container = document.getElementById('scheduleContainer');
            const timeSlots = generateTimeSlots();
            const filterValue = (document.getElementById('filterMember') || {value:''}).value || '';

            container.innerHTML = '';
            timeSlots.forEach(day => {
                const dayHasFiltered = day.slots.some(s => {
                    const arr = scheduleData[s.id] || [];
                    return filterValue ? arr.includes(filterValue) : true;
                });
                if (!dayHasFiltered) return;

                const dayDiv = document.createElement('div');
                dayDiv.className = 'schedule-container';
                const dayHeader = `<div class="day-header">${day.day}</div>`;
                const slotCards = day.slots.map(slot => {
                    const arr = scheduleData[slot.id] || [];
                    if (filterValue && !arr.includes(filterValue)) {
                        return '';
                    }
                    const assignedChips = arr.map((name, idx) => `
                        <span class="chip">${name}
                            <button title="Retirer" onclick="removeAssignee('${slot.id}', ${idx}); event.stopPropagation();">&times;</button>
                        </span>
                    `).join(' ');

                    const selects = (arr.length < 2) ? `
                        <select class="member-select" onchange="assignSlot('${slot.id}', this.value); this.value='';" onclick="event.stopPropagation()">
                            <option value="">+ Ajouter une personne...</option>
                            ${members
                                .filter(m => !arr.includes(m))
                                .map(m => `<option value="${m}">${m}</option>`).join('')}
                        </select>
                    ` : `<em>Max 2 personnes</em>`;

                    const timeRange = `${slot.startDate.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})} - ${slot.endDate.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`;
                    return `
                        <div id="slot-${slot.id}" class="time-slot ${arr.length ? 'assigned' : ''}" onclick="clearSlot('${slot.id}')">
                            <div class="time-range">${timeRange}</div>
                            <div class="assigned-to">
                                ${assignedChips || '<span style="color:#6c757d">Aucun inscrit</span>'}
                                ${selects}
                            </div>
                        </div>
                    `;
                }).join('');

                dayDiv.innerHTML = dayHeader + `<div class="time-slots">${slotCards}</div>`;
                container.appendChild(dayDiv);
            });
            updateSummary();
        }

        function assignSlot(slotId, member) {
            if (!member) return;
            const arr = scheduleData[slotId] || [];
            if (arr.includes(member)) { showToast(member + ' est d√©j√† sur ce cr√©neau.'); return; }
            if (arr.length >= 2) { showToast('Ce cr√©neau a d√©j√† 2 personnes.'); return; }
            apiSetSlot(slotId, 'add', member).then(async ()=>{
                await fetchState();
                createSchedule();
                showToast('Ajout√© : ' + member);
            }).catch(()=>showToast('Erreur de sauvegarde (r√©essaie)'));
        }
            if (arr.length >= 2) { showToast('Ce cr√©neau a d√©j√† 2 personnes.'); return; }
            scheduleData[slotId] = [...arr, member];
            createSchedule();
            showToast('Ajout√© : ' + member);
        }

        function removeAssignee(slotId, index) {
            const arr = scheduleData[slotId] || [];
            const member = arr[index];
            apiSetSlot(slotId, 'remove', member).then(async ()=>{
                await fetchState();
                createSchedule();
                showToast('Personne retir√©e');
            }).catch(()=>showToast('Erreur de sauvegarde (r√©essaie)'));
        }

        function clearSlot(slotId) {
            if (!scheduleData[slotId]) return;
            apiSetSlot(slotId, 'clear').then(async ()=>{
                await fetchState();
                createSchedule();
                showToast('Cr√©neau remis √† z√©ro');
            }).catch(()=>showToast('Erreur de sauvegarde (r√©essaie)'));
        }
        }

        // SUMMARY + EXPORTS
        function updateSummary() {
            document.getElementById('totalMembers').textContent = members.length;
            const tshirtsSelected = Object.values(tshirtData).filter(x => x).length;
            const slotsAssigned = Object.values(scheduleData).reduce((acc, arr) => acc + (arr?.length || 0), 0);
            const totalSlots = generateTimeSlots().reduce((acc, day) => acc + day.slots.length, 0);
            const slotsFree = Math.max(totalSlots - slotsAssigned, 0);

            document.getElementById('tshirtsSelected').textContent = tshirtsSelected;
            document.getElementById('slotsAssigned').textContent = slotsAssigned;
            document.getElementById('totalSlots').textContent = totalSlots;
            document.getElementById('slotsFree').textContent = slotsFree;
        }

        function exportTshirtData() {
            const data = members.map(member => ({ Membre: member, Taille: tshirtData[member] || 'Non s√©lectionn√©e' }));
            downloadCSV(data, 'tailles-tshirts-relais-vie.csv');
        }

        function exportScheduleData() {
            const entries = Object.entries(scheduleData);
            if (entries.length === 0) { alert('Aucune donn√©e √† exporter'); return; }
            const rows = [];
            entries.forEach(([slotId, assignees]) => {
                const startDate = new Date(Number(slotId));
                const endDate = new Date(startDate.getTime() + 30*60000);
                const dateLabel = startDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
                const timeRange = `${startDate.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})} - ${endDate.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`;
                (assignees || []).forEach(person => {
                    rows.push({ Date: dateLabel, Heure: timeRange, 'Membre assign√©': person });
                });
            });
            if (!rows.length) { alert('Aucune donn√©e √† exporter'); return; }
            downloadCSV(rows, 'planning-marche-relais-vie.csv');
        }

        function exportAllData() {
            const allData = { tshirts: tshirtData, schedule: scheduleData, members };
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'donnees-relais-vie-complete.json';
            link.click();
        }

        function downloadCSV(data, filename) {
            if (!data.length) { alert('Aucune donn√©e √† exporter'); return; }
            const headers = Object.keys(data[0]);
            const csv = [ headers.join(','), ...data.map(r => headers.map(h => `"${(r[h] ?? '').toString().replace(/"/g,'""')}"`).join(',')) ].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
        }

        
        
        // --- Helpers: fetch with timeout & error banner ---
        function fetchWithTimeout(resource, options = {}){
            const { timeout = 6000 } = options;
            return new Promise((resolve, reject) => {
                const timer = setTimeout(() => reject(new Error('timeout')), timeout);
                fetch(resource, options).then(
                    response => { clearTimeout(timer); resolve(response); },
                    err => { clearTimeout(timer); reject(err); }
                );
            });
        }
        function showError(msg){
            const b = document.getElementById('errorBanner');
            if(!b) return;
            b.textContent = '‚ö†Ô∏è ' + msg;
            b.style.display = 'block';
        }

        // --- Backend (Netlify Functions + Blobs) ---
        const API = {
            get: '/.netlify/functions/state-get',
            setTshirt: '/.netlify/functions/state-set-tshirt',
            setSlot: '/.netlify/functions/state-set-slot'
        };
        async function fetchState() { try {
            const res = await fetchWithTimeout(API.get, { cache: 'no-store', timeout: 6000 });
            const data = await res.json();
            // hydrate local state
            if (data.tshirtData) tshirtData = data.tshirtData;
            if (data.scheduleData) scheduleData = data.scheduleData;
            if (Array.isArray(data.members) && data.members.length) {
                // keep our members order but merge if needed
                const merged = Array.from(new Set([...members, ...data.members]));
                if (merged.length !== members.length) {
                    members.splice(0, members.length, ...merged);
                    initFilter();
                }
            }
        } catch(e){ console.warn('fetchState error', e); showError("Connexion au serveur indisponible : affichage local seulement."); }
        async function apiSetTshirt(member, size){
            await fetch(API.setTshirt, {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ member, size, members })
            });
        }
        async function apiSetSlot(slotId, action, member){
            await fetch(API.setSlot, {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ slotId, action, member, members })
            });
        }
        // Optional polling to keep multiple users in sync
        let __poller;
        function startPolling(){
            stopPolling();
            __poller = setInterval(async () => {
                await fetchState();
                createTshirtGrid();
                createSchedule();
                updateSummary();
            }, 12000);
        }
        function stopPolling(){ if(__poller) clearInterval(__poller); }

        // Modal helpers
        function showAssignedSlots() {
            const listDiv = document.getElementById('slotsList');
            document.getElementById('slotsModalTitle').textContent = 'Cr√©neaux assign√©s';
            const entries = Object.entries(scheduleData);
            if (entries.length === 0) {
                listDiv.innerHTML = "<p>Aucun cr√©neau assign√©.</p>";
            } else {
                let html = "<ul style='padding-left:20px'>";
                entries
                  .sort((a,b)=>Number(a[0])-Number(b[0]))
                  .forEach(([slotId, assignees]) => {
                    const startDate = new Date(Number(slotId));
                    const endDate = new Date(startDate.getTime() + 30*60000);
                    const timeRange = `${startDate.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})} - ${endDate.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`;
                    const dateLabel = startDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
                    html += `<li><button onclick=\"goToSlot('${slotId}')\"><strong>${dateLabel} ${timeRange}</strong> ‚Ä¢ ${assignees.join(", ")}</button></li>`;
                });
                html += "</ul>";
                listDiv.innerHTML = html;
            }
            document.getElementById('slotsModal').style.display = 'flex';
        }
        
        function showTshirtSelections(){
            const listDiv = document.getElementById('slotsList');
            document.getElementById('slotsModalTitle').textContent = 'T-shirts s√©lectionn√©s';
            const selected = Object.entries(tshirtData).filter(([m,v]) => !!v);
            const notSelected = Object.entries(tshirtData).filter(([m,v]) => !v);
            let html = "";
            html += "<h4>‚úÖ Avec taille ("+selected.length+")</h4>";
            if(selected.length){
                html += "<ul style='padding-left:20px'>";
                selected.sort((a,b)=>a[0].localeCompare(b[0])).forEach(([m,v])=>{
                    html += `<li><button onclick=\"goToMember('${m}')\"><strong>${m}</strong> ‚Ä¢ ${v}</button></li>`;
                });
                html += "</ul>";
            } else {
                html += "<p>Aucun membre n'a encore choisi sa taille.</p>";
            }
            html += "<h4 style='margin-top:10px;'>üïò Sans taille ("+notSelected.length+")</h4>";
            if(notSelected.length){
                html += "<ul style='padding-left:20px'>";
                notSelected.sort((a,b)=>a[0].localeCompare(b[0])).forEach(([m,_])=>{
                    html += `<li><button onclick=\"goToMember('${m}')\"><strong>${m}</strong> ‚Ä¢ s√©lectionner</button></li>`;
                });
                html += "</ul>";
            } else {
                html += "<p>Tout le monde a choisi sa taille. üí™</p>";
            }
            listDiv.innerHTML = html;
            document.getElementById('slotsModal').style.display = 'flex';
        }
        function goToMember(member){
            // switch to T-shirts tab
            const tshirtTabBtn = Array.from(document.querySelectorAll('.tab')).find(b=>b.textContent.includes('T-Shirts'));
            if (tshirtTabBtn) tshirtTabBtn.click();
            setTimeout(()=>{
                const id = 'member-'+member.replace(/[^a-z0-9]/gi,'-').toLowerCase();
                const el = document.getElementById(id);
                if(el){
                    el.scrollIntoView({behavior:'smooth', block:'center'});
                    el.classList.add('highlight');
                    setTimeout(()=>el.classList.remove('highlight'), 2000);
                }
                document.getElementById('slotsModal').style.display='none';
            }, 150);
        }
function showFreeSlots(){
            const listDiv = document.getElementById('slotsList');
            document.getElementById('slotsModalTitle').textContent = 'Cr√©neaux libres';
            const all = generateTimeSlots().flatMap(d => d.slots);
            const free = all.filter(s => !(scheduleData[s.id] && scheduleData[s.id].length));
            if (free.length === 0) {
                listDiv.innerHTML = "<p>Tous les cr√©neaux sont remplis. üí™</p>";
            } else {
                let html = "<ul style='padding-left:20px'>";
                free.forEach(slot => {
                    const startDate = new Date(Number(slot.id));
                    const endDate = new Date(startDate.getTime() + 30*60000);
                    const timeRange = `${startDate.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})} - ${endDate.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`;
                    const dateLabel = startDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
                    html += `<li><button onclick=\"goToSlot('${slot.id}')\"><strong>${dateLabel} ${timeRange}</strong> ‚Ä¢ Ajouter quelqu'un</button></li>`;
                });
                html += "</ul>";
                listDiv.innerHTML = html;
            }
            document.getElementById('slotsModal').style.display = 'flex';
        }
        function closeModalOnBackdrop(e){
            if(e.target && e.target.id === 'slotsModal'){
                e.currentTarget.style.display='none';
            }
        } catch(e){ console.warn('fetchState error', e); showError("Connexion au serveur indisponible : affichage local seulement."); }
        function goToSlot(slotId){
            // switch to schedule tab
            const scheduleTabBtn = Array.from(document.querySelectorAll('.tab')).find(b=>b.textContent.includes('Planning'));
            if (scheduleTabBtn) scheduleTabBtn.click();
            // after DOM rebuild
            setTimeout(()=>{
                const el = document.getElementById('slot-'+slotId);
                if(el){
                    el.scrollIntoView({behavior:'smooth', block:'center'});
                    el.classList.add('highlight');
                    setTimeout(()=>el.classList.remove('highlight'), 2000);
                }
                document.getElementById('slotsModal').style.display='none';
            }, 150);
        }

        // Netlify
        function prepareNetlifyPayload() {
            // Fill hidden fields before Netlify captures the submission
            try {
            document.getElementById('tshirtDataField').value = JSON.stringify(tshirtData);
            document.getElementById('scheduleDataField').value = JSON.stringify(scheduleData);
            document.getElementById('membersField').value = JSON.stringify(members);
            } catch(e) { console.error('Payload prep error', e); }
        }

        // Toast
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            clearTimeout(window.__toastTimer);
            window.__toastTimer = setTimeout(() => t.classList.remove('show'), 1800);
        }

        
        // --- Local preview guard: prevent navigation when not deployed ---
        function __isLocalPreview(){
            return location.protocol === 'file:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        }
        (function(){
            const form = document.querySelector('form[name="RelaisVieInscription"]');
            if(form){
                form.addEventListener('submit', function(e){
                    // prepare payload again to be extra safe
                    prepareNetlifyPayload();
                    if(__isLocalPreview()){
                        e.preventDefault();
                        showToast('Simulation locale : donn√©es pr√™tes. D√©ploie sur Netlify pour envoyer.');
                        console.log('Form submission prevented in local preview.');
                    }
                });
            }
        } catch(e){ console.warn('fetchState error', e); showError("Connexion au serveur indisponible : affichage local seulement."); })();

        
        // --- Persistence (localStorage) ---
        const STORAGE_KEY = 'relaisVieState.v1';
        function saveState(){
            try{
                const payload = { tshirtData, scheduleData, ts: Date.now() };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
                const el = document.getElementById('lastSaved');
                if(el){
                    const d = new Date(payload.ts);
                    el.textContent = 'Sauvegard√© localement √† ' + d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
                }
            }catch(e){ console.warn('saveState error', e); }
        }
        function loadState(){
            try{
                const raw = localStorage.getItem(STORAGE_KEY);
                if(!raw) return;
                const data = JSON.parse(raw);
                if(data && typeof data === 'object'){
                    if(data.tshirtData) tshirtData = Object.assign({}, tshirtData, data.tshirtData);
                    if(data.scheduleData) scheduleData = data.scheduleData;
                }
            }catch(e){ console.warn('loadState error', e); }
        }
        function resetLocalState(){
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }

        // boot
        initFilter();
        try { await fetchState(); } catch(e){ console.warn('Initial fetch failed', e); showError('Serveur indisponible, mode local.'); }
        createTshirtGrid();
        createSchedule();
        updateSummary();
        try { startPolling(); } catch(e){ console.warn('Polling init failed', e);}
        })();
    </script>
</body>
</html>
