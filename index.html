
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lions Club La LouviÃ¨re - Relais pour la Vie</title>
  <style>
    :root { --orange:#ff7a18; --purple:#5B5FEF; --green:#1b9e5a; --muted:#666; }
    body{margin:0;font-family:Inter,Arial,sans-serif;background:linear-gradient(120deg,#5B5FEF,#9C27B0);min-height:100vh;}
    .wrap{max-width:1100px;margin:40px auto;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden}
    header{padding:22px 24px;background:linear-gradient(90deg,var(--orange),#ff3d00);color:#fff;font-weight:800;font-size:32px;text-shadow:0 2px 6px rgba(0,0,0,.25)}
    .sub{padding:0 24px 16px;color:#ffe;opacity:.95}
    .tabs{display:flex;border-bottom:1px solid #eee;background:#fafafa}
    .tab-button{flex:1;border:0;border-bottom:3px solid transparent;padding:12px 16px;background:#fafafa;cursor:pointer;font-weight:700}
    .tab-button.active{border-color:var(--purple);background:#fff;color:var(--purple)}
    main{padding:18px}
    .row{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
    .card{border:1px solid #eee;border-radius:12px;padding:12px 14px}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
    .kpi div{background:#E8F5E9;color:#2E7D32;border-radius:10px;padding:14px;text-align:center;font-weight:700}
    .slot{display:flex;align-items:center;gap:8px;margin:6px 0}
    label{font-size:13px;color:#333}
    select,input,button.action{border:1px solid #ddd;border-radius:8px;padding:8px 10px}
    button.action{background:var(--purple);color:#fff;font-weight:700;cursor:pointer}
    button.action.secondary{background:#e0e0ff;color:#333}
    button.action:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    .hidden{display:none}
    .list{margin-top:10px;max-height:280px;overflow:auto;border:1px dashed #ddd;border-radius:10px;padding:10px}
    .list a{display:inline-block;margin:4px 6px;text-decoration:none;background:#f6f6ff;border:1px solid #ddd;padding:4px 8px;border-radius:6px}
    .pill{display:inline-block;background:#eef;border:1px solid #dde;border-radius:999px;padding:2px 8px;margin-left:6px;font-size:12px}
    .posrow{display:flex; gap:8px; align-items:center; margin:6px 0;}
    .posrow label{width:60px; color:#555;}
    table{width:100%; border-collapse:collapse; margin:10px 0; font-size:14px}
    th,td{border:1px solid #e9e9e9; padding:8px 10px; text-align:left}
    th{background:#fafafa}
  </style>
</head>
<body>
  <div class="wrap">
    <header>ğŸƒ Lions Club La LouviÃ¨re - Relais pour la Vie</header>
    <div class="sub">La LouviÃ¨re â€¢ 11-12 Octobre 2025</div>
    <div class="tabs">
      <button class="tab-button active" onclick="switchTab('tshirts')">ğŸ‘• Tailles Tâ€‘Shirts</button>
      <button class="tab-button" onclick="switchTab('planning')">ğŸ—“ï¸ Planning Marche</button>
      <button class="tab-button" onclick="switchTab('resume')">ğŸ“Š RÃ©sumÃ©</button>
    </div>
    <main>
      <section id="tshirts" class="tab-content">
        <h3>SÃ©lection des tailles</h3>
        <div class="row" id="tshirtsBox"></div>
      </section>

      <section id="planning" class="tab-content hidden">
        <h3>RÃ©server un crÃ©neau (jusqu'Ã  2 personnes / crÃ©neau)</h3>
        <p class="muted">On peut libÃ©rer un crÃ©neau Ã  tout moment (bouton â€œRetirerâ€).</p>
        <div class="row" id="slotsBox"></div>
      </section>

      <section id="resume" class="tab-content hidden">
        <h3>RÃ©sumÃ© de l'organisation</h3>
        <div class="kpi">
          <div><span id="k1">0</span><br/>Membres</div>
          <div><span id="k2">0</span><br/>Tâ€‘Shirts choisis</div>
          <div><span id="k3">0</span><br/>CrÃ©neaux rÃ©servÃ©s</div>
          <div><span id="k4">0</span><br/>CrÃ©neaux dispo</div>
        </div>

        <div style="margin-top:12px;">
          <a id="showTshirts" style="cursor:pointer; color:#5B5FEF; text-decoration:underline; margin-right:12px;">ğŸ‘• Voir dÃ©tails Tâ€‘Shirts</a>
          <a id="showSlots" style="cursor:pointer; color:#5B5FEF; text-decoration:underline;">ğŸ—“ï¸ Voir dÃ©tails crÃ©neaux rÃ©servÃ©s</a>
        </div>

        <div id="tshirtsDetails" class="hidden">
          <h4>ğŸ‘• DÃ©tails Tâ€‘Shirts par personne</h4>
          <table id="tblTshirts">
            <thead><tr><th>Nom</th><th>Taille</th></tr></thead>
            <tbody></tbody>
          </table>
          <h5>RÃ©partition par tailles</h5>
          <div id="sizesBreak"></div>
        </div>

        <div id="slotsDetails" class="hidden">
          <h4>ğŸ—“ï¸ DÃ©tails crÃ©neaux rÃ©servÃ©s</h4>
          <table id="tblSlots">
            <thead><tr><th>CrÃ©neau</th><th>Personne 1</th><th>Personne 2</th><th>Ã‰tat</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <h4 style="margin-top:18px;">ğŸ”’ CrÃ©neaux dÃ©jÃ  pris</h4>
        <div id="listTaken" class="list"></div>
        <h4 style="margin-top:18px;">âœ… CrÃ©neaux disponibles</h4>
        <div id="listFree" class="list"></div>
      </section>
    </main>
  </div>

  <script>
    function switchTab(id){
      document.querySelectorAll('.tab-content').forEach(s=>s.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
      const btn = Array.from(document.querySelectorAll('.tab-button')).find(b=>b.getAttribute('onclick').includes(id));
      if(btn) btn.classList.add('active');
    }

    const MEMBERS = ["Yvan D","Michelina C","Pasquale D","Enora D","VÃ©ronique L","Sandy","Manuela","Christophe G","Pino D","Malika Z","Nolann D","Irina","Le fils de Sandy","Le fils de Manuela","Cyril G","Mario D","Olivier D","Aurore V","Sabrina","Yves E"];

    function genSlots(){
      const start = new Date(2025, 9, 11, 15, 0, 0);
      const end   = new Date(2025, 9, 12, 15, 0, 0);
      const slots = [];
      for(let t = new Date(start); t < end; t = new Date(t.getTime() + 30*60*1000)){
        const t2 = new Date(t.getTime() + 30*60*1000);
        const dow = t.getDay();
        const pfx = (dow===6? 'sam' : 'dim');
        const fmt = (d)=> d.toLocaleTimeString('fr-BE',{hour:'2-digit',minute:'2-digit',hour12:false});
        slots.push(`${pfx} ${fmt(t)}-${fmt(t2)}`);
      }
      return slots;
    }
    const SLOTS = genSlots();

    async function getState(){ const r = await fetch('/api/state-get'); return r.json(); }
    async function setTshirt(name,size,email=""){
      const r = await fetch('/api/state-set-tshirt',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({name,size,email})});
      return r.json();
    }
    async function clearTshirt(name){
      const r = await fetch('/api/state-set-tshirt',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({name, clear:true})});
      return r.json();
    }
    async function setSlot(slotId,name){
      const r = await fetch('/api/state-set-slot',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({slotId,name})});
      return r.json();
    }
    async function unsetSlot(slotId,name){
      const r = await fetch('/api/state-unset-slot',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({slotId,name})});
      return r.json();
    }

    function renderTshirts(state){
      const box = document.getElementById('tshirtsBox'); box.innerHTML='';
      const sizes = ["XS","S","M","L","XL","XXL"];
      MEMBERS.forEach(m=>{
        const div = document.createElement('div'); div.className='card';
        const current = state.tshirtData[m] || "";
        // label + pill quand fixÃ©
        const title = document.createElement('div');
        title.innerHTML = `<strong>${m}</strong>` + (current ? ` <span class="pill">${current}</span>` : '');
        div.appendChild(title);

        const sel = document.createElement('select');
        const ph = document.createElement('option'); ph.value=""; ph.textContent="-- Choisir une taille --"; sel.appendChild(ph);
        sizes.forEach(s=>{ const o=document.createElement('option'); o.value=s;o.textContent=s; sel.appendChild(o); });
        sel.value = current;

        const save = async ()=>{
          if(!sel.value) return;
          await setTshirt(m, sel.value);
          await load();
        };

        // Auto-save + freeze
        sel.addEventListener('change', save);
        if (current) sel.disabled = true;

        // Boutons: Modifier (dÃ©verrouille), Effacer
        const actions = document.createElement('div'); actions.style.marginTop='8px';
        const btnEdit = document.createElement('button'); btnEdit.textContent = current ? 'Modifier' : 'Enregistrer'; btnEdit.className='action';
        btnEdit.onclick = async ()=>{
          if (!current) { await save(); }
          else { sel.disabled = false; sel.focus(); }
        };
        const btnClear = document.createElement('button'); btnClear.textContent = 'Effacer'; btnClear.className='action secondary'; btnClear.style.marginLeft='6px';
        btnClear.onclick = async ()=>{ await clearTshirt(m); await load(); };

        div.appendChild(sel);
        div.appendChild(actions);
        actions.appendChild(btnEdit);
        actions.appendChild(btnClear);
        box.appendChild(div);
      });
    }

    function cssId(s){ return s.replace(/[^a-z0-9]+/gi,'-'); }

    function renderSlots(state){
      const box = document.getElementById('slotsBox'); box.innerHTML='';
      SLOTS.forEach(id=>{
        const div = document.createElement('div'); div.className='card'; div.id = `slot-${cssId(id)}`;
        const takenArr = (state.scheduleData[id]||[]);
        const spotsLeft = Math.max(0, 2 - takenArr.length);
        const takenTxt = takenArr.join(', ') || 'â€”';
        div.innerHTML = `<strong>${id}</strong><span class="pill">${spotsLeft} place(s) restante(s)</span><div class="muted">OccupÃ©: ${takenTxt}</div>`;

        // Deux lignes (rÃ©servable + libÃ©rable)
        for(let pos=0; pos<2; pos++){
          const row = document.createElement('div'); row.className='posrow';
          const label = document.createElement('label'); label.textContent = `Pers. ${pos+1}`;

          const current = takenArr[pos] || "";

          if (current) {
            // affichage nom + bouton Retirer
            const nameSpan = document.createElement('span'); nameSpan.textContent = current;
            const btnFree = document.createElement('button'); btnFree.textContent='Retirer'; btnFree.className='action secondary';
            btnFree.onclick = async ()=>{ await unsetSlot(id, current); await load(); };
            row.appendChild(label); row.appendChild(nameSpan); row.appendChild(btnFree);
          } else {
            // sÃ©lecteur pour ajouter quelqu'un
            const sel = document.createElement('select');
            const ph = document.createElement('option'); ph.value=""; ph.textContent="-- Choisir une personne --"; sel.appendChild(ph);
            MEMBERS.forEach(m=>{ const o=document.createElement('option'); o.value=m;o.textContent=m; sel.appendChild(o); });
            const btn = document.createElement('button'); btn.textContent='RÃ©server'; btn.className='action'; btn.disabled = true;
            sel.addEventListener('change', ()=>{ btn.disabled = !sel.value; });
            btn.onclick = async ()=>{ if(!sel.value) return; await setSlot(id, sel.value); await load(); };
            row.appendChild(label); row.appendChild(sel); row.appendChild(btn);
          }

          div.appendChild(row);
        }

        box.appendChild(div);
      });
    }

    function renderSummary(state){
      const taken = [], free = [];
      SLOTS.forEach(id => {
        const n = (state.scheduleData[id]||[]).length;
        if (n > 0) taken.push(id);
        if (n < 2) free.push(id);
      });
      document.getElementById('k1').textContent = state.members.length;
      document.getElementById('k2').textContent = Object.keys(state.tshirtData).length;
      document.getElementById('k3').textContent = SLOTS.reduce((a,id)=>a + ((state.scheduleData[id]||[]).length), 0);
      document.getElementById('k4').textContent = free.length;

      const listTaken = document.getElementById('listTaken'); listTaken.innerHTML='';
      taken.forEach(id=>{
        const a = document.createElement('a'); a.href = `#slot-${cssId(id)}`; a.textContent = id;
        a.onclick = ()=>{ switchTab('planning'); setTimeout(()=>{ document.getElementById(`slot-${cssId(id)}`)?.scrollIntoView({behavior:'smooth',block:'center'}); },50); };
        listTaken.appendChild(a);
      });
      const listFree = document.getElementById('listFree'); listFree.innerHTML='';
      free.forEach(id=>{
        const a = document.createElement('a'); a.href = `#slot-${cssId(id)}`; a.textContent = id;
        a.onclick = ()=>{ switchTab('planning'); setTimeout(()=>{ document.getElementById(`slot-${cssId(id)}`)?.scrollIntoView({behavior:'smooth',block:'center'}); },50); };
        listFree.appendChild(a);
      });

      // Toggle details
      document.getElementById('showTshirts').onclick = ()=>{
        document.getElementById('tshirtsDetails').classList.toggle('hidden');
      };
      document.getElementById('showSlots').onclick = ()=>{
        document.getElementById('slotsDetails').classList.toggle('hidden');
      };

      // T-shirts table
      const tbodyT = document.querySelector('#tblTshirts tbody'); tbodyT.innerHTML='';
      const sizesCount = {};
      Object.entries(state.tshirtData).forEach(([name,size])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${name}</td><td>${size}</td>`;
        tbodyT.appendChild(tr);
        sizesCount[size] = (sizesCount[size] || 0) + 1;
      });
      const sizesBreak = document.getElementById('sizesBreak'); sizesBreak.innerHTML='';
      Object.keys(sizesCount).sort().forEach(s=>{
        const b = document.createElement('span'); b.className='pill'; b.textContent = `${sizesCount[s]}Ã— ${s}`;
        sizesBreak.appendChild(b);
      });

      // Slots details
      const tbodyS = document.querySelector('#tblSlots tbody'); tbodyS.innerHTML='';
      SLOTS.forEach(id=>{
        const arr = state.scheduleData[id]||[];
        if (arr.length>0){
          const tr = document.createElement('tr');
          const p1 = arr[0] || 'â€”';
          const p2 = arr[1] || 'â€”';
          const etat = (arr.length===2) ? 'Complet' : '1 place restante';
          tr.innerHTML = `<td>${id}</td><td>${p1}</td><td>${p2}</td><td>${etat}</td>`;
          tbodyS.appendChild(tr);
        }
      });
    }

    async function load(){
      const state = await getState();
      renderTshirts(state);
      renderSlots(state);
      renderSummary(state);
    }
    load(); setInterval(load, 10000);
  </script>
</body>
</html>
