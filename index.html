<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Lions Club - Relais pour la Vie</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#fafafa; }
    nav button { margin: 5px; padding: 10px 15px; border:none; border-radius:8px; background:#005baa; color:#fff; cursor:pointer; }
    nav button.active { background:#ffcc00; color:#000; font-weight:bold; }
    section { display:none; margin-top:20px; }
    section.active { display:block; }
    table { border-collapse: collapse; width:100%; margin-top:10px; background:#fff; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; }
    th { background:#eee; }
    select:disabled { background:#ddd; color:#555; }
    .remove-btn { margin-left:10px; padding:3px 8px; border:none; border-radius:5px; background:#d9534f; color:#fff; cursor:pointer; }
  </style>
</head>
<body>
  <h1>Lions Club La Louvière - Relais pour la Vie</h1>
  <nav>
    <button data-tab="tshirts" class="active">Tailles T-shirts</button>
    <button data-tab="planning">Planning Marche</button>
    <button data-tab="resume">Résumé</button>
  </nav>

  <section id="tshirts" class="active">
    <h2>Choix des tailles T-shirts</h2>
    <div id="tshirt-list"></div>
  </section>

  <section id="planning">
    <h2>Planning Marche</h2>
    <div id="planning-list"></div>
  </section>

  <section id="resume">
    <h2>Résumé des inscriptions</h2>
    <pre id="resume-content"></pre>
  </section>

  <script>
    const MEMBERS = ["Yvan D","Céline D","Nolann D","Enora D"];
    const SIZES = ["XS","S","M","L","XL","XXL"];
    const SLOTS = (()=>{
      const slots=[];
      const start=new Date("2025-10-11T15:00:00");
      const end=new Date("2025-10-12T15:00:00");
      for(let t=new Date(start); t<=end; t.setMinutes(t.getMinutes()+30)){
        slots.push("slot-"+t.toISOString().slice(0,16).replace("T","-"));
      }
      return slots;
    })();

    let state={tshirtData:{},scheduleData:{}};

    async function loadState(){
      const r=await fetch("/api/state-get");
      state=await r.json();
    }

    async function apiSetTshirt(name,size){
      return fetch("/api/state-set-tshirt",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({name,size})
      });
    }

    async function apiSetSlot(slotId,pos,name){
      return fetch("/api/state-set-slot",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({slotId,pos,name})
      });
    }

    function renderTshirts(){
      const container=document.getElementById("tshirt-list");
      container.innerHTML="";
      MEMBERS.forEach(name=>{
        const div=document.createElement("div");
        const sel=document.createElement("select");
        sel.innerHTML='<option value="">-- Choisir --</option>'+SIZES.map(s=>`<option value="${s}">${s}</option>`).join("");
        sel.value=state.tshirtData[name]||"";
        if(sel.value) sel.disabled=true;

        sel.addEventListener("change",async e=>{
          const val=e.target.value;
          await apiSetTshirt(name,val);
          await loadState();
          renderTshirts();
          renderResume();
          // auto-bascule vers Planning à la première sélection de ce membre
          if(val && !state.scheduleData.some(slot=>Object.values(slot).includes(name))){
            document.querySelector('nav button[data-tab="planning"]').click();
          }
        });

        const btn=document.createElement("button");
        btn.textContent="Retirer";
        btn.className="remove-btn";
        btn.addEventListener("click",async()=>{
          await apiSetTshirt(name,"");
          await loadState();
          renderTshirts();
          renderResume();
        });

        div.textContent=name+" : ";
        div.appendChild(sel);
        div.appendChild(btn);
        container.appendChild(div);
      });
    }

    function renderPlanning(){
      const container=document.getElementById("planning-list");
      container.innerHTML="";
      SLOTS.forEach(slotId=>{
        const tr=document.createElement("div");
        tr.innerHTML="<strong>"+slotId+"</strong> ";
        [1,2].forEach(pos=>{
          const sel=document.createElement("select");
          sel.innerHTML='<option value="">-- Libre --</option>'+MEMBERS.map(m=>`<option value="${m}">${m}</option>`).join("");
          sel.value=(state.scheduleData[slotId]||{})["p"+pos]||"";
          if(sel.value) sel.disabled=true;

          sel.addEventListener("change",async e=>{
            const val=e.target.value;
            await apiSetSlot(slotId,"p"+pos,val);
            await loadState();
            renderPlanning();
            renderResume();
          });

          const btn=document.createElement("button");
          btn.textContent="Retirer";
          btn.className="remove-btn";
          btn.addEventListener("click",async()=>{
            await apiSetSlot(slotId,"p"+pos,"");
            await loadState();
            renderPlanning();
            renderResume();
          });

          tr.appendChild(sel);
          tr.appendChild(btn);
        });
        container.appendChild(tr);
      });
    }

    function renderResume(){
      document.getElementById("resume-content").textContent=JSON.stringify(state,null,2);
    }

    document.querySelectorAll("nav button").forEach(btn=>{
      btn.addEventListener("click",()=>{
        document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll("section").forEach(sec=>sec.classList.remove("active"));
        document.getElementById(btn.dataset.tab).classList.add("active");
      });
    });

    (async()=>{
      await loadState();
      renderTshirts();
      renderPlanning();
      renderResume();
    })();
  </script>
</body>
</html>
