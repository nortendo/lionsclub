<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relais pour la Vie - La Louvi√®re</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(45deg, #ff6b6b, #ffa500); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.2rem; opacity: 0.9; }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #dee2e6; }
        .tab { flex: 1; padding: 15px 20px; text-align: center; cursor: pointer; border: none; background: none; font-size: 1.1rem; font-weight: 600; color: #6c757d; transition: all 0.3s ease; }
        .tab.active { background: white; color: #495057; border-bottom: 3px solid #ff6b6b; }
        .tab:hover:not(.active) { background: #e9ecef; color: #495057; }
        .content { padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tshirt-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .member-card { background: #f8f9fa; border-radius: 10px; padding: 20px; border: 2px solid #e9ecef; transition: all 0.3s ease; }
        .member-card:hover { border-color: #ff6b6b; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .member-name { font-weight: bold; font-size: 1.1rem; color: #495057; margin-bottom: 10px; }
        .size-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
        .size-btn { padding: 8px 12px; border: 2px solid #dee2e6; background: white; border-radius: 20px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; min-width: 45px; text-align: center; }
        .size-btn:hover { border-color: #ff6b6b; background: #fff5f5; }
        .size-btn.selected { background: #ff6b6b; color: white; border-color: #ff6b6b; }
        .schedule-container { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .day-header { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center; font-size: 1.3rem; font-weight: bold; }
        .time-slots { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 10px; }
        .time-slot { background: white; border: 2px solid #dee2e6; border-radius: 8px; padding: 12px; transition: all 0.2s ease; }
        .time-slot:hover { border-color: #28a745; background: #f8fff9; }
        .time-slot.assigned { border-color: #28a745; background: #d4edda; }
        .time-range { font-weight: bold; font-size: 1rem; color: #495057; margin-bottom: 5px; }
        .assigned-to { font-size: 0.9rem; color: #155724; font-weight: 600; display: flex; flex-direction: column; gap: 6px; }
        .member-select { width: 100%; padding: 5px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem; }
        .chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; background: #20c997; color: white; border-radius: 999px; font-size: 0.85rem; }
        .chip button { background: rgba(0,0,0,0.15); border: none; color: white; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; }
        .summary { background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .summary h3 { margin-bottom: 15px; font-size: 1.3rem; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .summary-item { text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; }
        .summary-number { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
        .export-btn, .submit-btn { background: linear-gradient(45deg, #007bff, #0056b3); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; margin: 10px 5px; transition: all 0.3s ease; }
        .export-btn:hover, .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,123,255,0.4); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
        .form-row label { font-weight: 600; color: #495057; }
        .form-row input, .form-row textarea { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 8px; font-size: 1rem; }
        .hp { display: none; visibility: hidden; }
        .toolbar { display:flex; gap:10px; align-items:center; margin-bottom:12px;}
        .toast { position: fixed; bottom: 24px; right: 24px; background: #212529; color: white; padding: 12px 16px; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.25); opacity: 0; transform: translateY(10px); transition: all .25s ease; pointer-events: none;}
        .toast.show { opacity: 1; transform: translateY(0); }
        @media (max-width: 768px) { .header h1 { font-size: 2rem; } .tabs { flex-direction: column; } .content { padding: 20px; } .tshirt-grid { grid-template-columns: 1fr; } .form-row { grid-template-columns: 1fr; } }
    </style>
<style>
/* Hide duplicated text links (KPI are clickable) */
a { }
a.kpi-dup-link{ display:none !important; }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÉ‚Äç‚ôÇÔ∏è Relais pour la Vie</h1>
            <p>La Louvi√®re ‚Ä¢ 11-12 Octobre 2025</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'tshirts')">üëï Tailles T-Shirts</button>
            <button class="tab" onclick="switchTab(event, 'schedule')">‚è∞ Planning Marche</button>
            <button class="tab" onclick="switchTab(event, 'summary')">üìä R√©sum√©</button>
        </div>

        <div class="content">
            <div id="tshirts" class="tab-content active">
                <h2 style="margin-bottom: 20px; color: #495057;">S√©lection des tailles de t-shirts</h2>
                <div class="tshirt-grid" id="tshirtGrid"></div>
                <button class="export-btn" onclick="exportTshirtData()">üì• Exporter les tailles</button>
            </div>

            <div id="schedule" class="tab-content">
                <div class="toolbar">
                    <label for="filterMember">Filtrer par membre :</label>
                    <select id="filterMember" class="member-select" style="max-width:280px" onchange="createSchedule()">
                        <option value="">-- Tous les membres --</option>
                    </select>
                </div>
                <h2 style="margin-bottom: 12px; color: #495057;">Planning des cr√©neaux de marche (jusqu'√† 2 personnes / cr√©neau)</h2>
                <div id="scheduleContainer"></div>
                <button class="export-btn" onclick="exportScheduleData()">üì• Exporter le planning</button>
            </div>

            <div id="summary" class="tab-content">
                <div class="summary">
                    <h3>üìà R√©sum√© de l'organisation</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-number" id="totalMembers">0</div>
                            <div>Membres</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number" id="tshirtsSelected">0</div>
                            <div>T-shirts s√©lectionn√©s</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number" id="slotsAssigned">0</div>
                            <div>Cr√©neaux assign√©s</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number" id="totalSlots">48</div>
                            <div>Cr√©neaux total</div>
                        </div>
                    </div>
                </div>

                <!-- Netlify form -->
                <form name="RelaisVieInscription" method="POST" data-netlify="true" netlify-honeypot="bot-field" action="/">
                    <input type="hidden" name="form-name" value="RelaisVieInscription">
                    <div class="hp" aria-hidden="true">
                        <label>Ne pas remplir si tu es humain: <input name="bot-field" /></label>
                    </div>

                    <div class="form-row">
                        <div>
                            <label for="nom">Nom / √âquipe</label>
                            <input type="text" id="nom" name="nom" placeholder="Ex: Lions C≈ìur de Hainaut" required>
                        </div>
                        <div>
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" placeholder="ton@email.com" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div>
                            <label for="commentaires">Commentaires</label>
                            <textarea id="commentaires" name="commentaires" rows="3" placeholder="Infos utiles (ex: tailles √† valider, contraintes horaires, etc.)"></textarea>
                        </div>
                        <div>
                            <label for="resume">R√©sum√© (auto)</label>
                            <textarea id="resume" name="resume" rows="3" readonly placeholder="Rempli automatiquement au moment de l'envoi"></textarea>
                        </div>
                    </div>

                    <!-- Hidden Netlify payload -->
                    <textarea id="tshirtDataField" name="tshirtData" hidden></textarea>
                    <textarea id="scheduleDataField" name="scheduleData" hidden></textarea>
                    <textarea id="membersField" name="members" hidden></textarea>

                    <button class="submit-btn" type="submit" onclick="prepareNetlifyPayload()">üì® Envoyer √† Netlify</button>
                </form>

                <button class="export-btn" onclick="exportAllData()">üì• Exporter tout</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const members = [
            'Yvan D','Christophe G','Cyril G','Michelina C','Pino D','Mario D',
            'Pasquale D','Malika Z','Olivier D','Enora D','Nolann D','Aurore V',
            'Veronique L','Irina','Sabrina','Sandy','Le fils de Sandy','Yves E',
            'Manuela','Le fils de Manuela','Sandy L'
        ];
        const sizes = ['XS','S','M','L','XL','XXL'];
        let tshirtData = {};
        let scheduleData = {}; // { slotId: [membre1?, membre2?] }

        // init
        members.forEach(m => { tshirtData[m] = null; });
        function initFilter() {
            const sel = document.getElementById('filterMember');
            sel.innerHTML = '<option value="">-- Tous les membres --</option>' + members.map(m => `<option value="${m}">${m}</option>`).join('');
        }

        function switchTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.target.classList.add('active');
            if (tabName === 'summary') updateSummary();
        }

        // T-SHIRTS
        function createTshirtGrid() {
            const grid = document.getElementById('tshirtGrid');
            grid.innerHTML = '';
            members.forEach(member => {
                const card = document.createElement('div');
                card.className = 'member-card';
                const sizeButtons = sizes.map(size => 
                    `<button class="size-btn ${tshirtData[member] === size ? 'selected' : ''}" onclick="selectSize('${member}','${size}')">${size}</button>`
                ).join('');
                card.innerHTML = `<div class="member-name">${member}</div><div class="size-buttons">${sizeButtons}</div>`;
                grid.appendChild(card);
            });
        }
        function selectSize(member, size) {
            tshirtData[member] = tshirtData[member] === size ? null : size;
            createTshirtGrid();
            updateSummary();
        }

        // SCHEDULE
        function generateTimeSlots() {
            const slots = [];
            const startDate = new Date('2025-10-11T15:00:00');
            const endDate = new Date('2025-10-12T15:00:00');
            let current = new Date(startDate);
            while (current < endDate) {
                const next = new Date(current.getTime() + 30 * 60000);
                const dayKey = current.toDateString();
                if (!slots.find(day => day.date === dayKey)) {
                    slots.push({
                        date: dayKey,
                        day: current.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' }),
                        slots: []
                    });
                }
                const daySlots = slots.find(day => day.date === dayKey);
                daySlots.slots.push({
                    id: `${current.getTime()}`,
                    startDate: new Date(current),
                    endDate: new Date(next)
                });
                current = next;
            }
            return slots;
        }

        function createSchedule() {
            const container = document.getElementById('scheduleContainer');
            const timeSlots = generateTimeSlots();
            const filterValue = (document.getElementById('filterMember') || {value:''}).value || '';

            container.innerHTML = '';
            timeSlots.forEach(day => {
                // If filter is applied, skip day if none of its slots include the member
                const dayHasFiltered = day.slots.some(s => {
                    const arr = scheduleData[s.id] || [];
                    return filterValue ? arr.includes(filterValue) : true;
                });
                if (!dayHasFiltered) return;

                const dayDiv = document.createElement('div');
                dayDiv.className = 'schedule-container';
                const dayHeader = `<div class="day-header">${day.day}</div>`;
                const slotCards = day.slots.map(slot => {
                    const arr = scheduleData[slot.id] || [];
                    if (filterValue && !arr.includes(filterValue)) {
                        // hide slots not matching filter when filter is set
                        return '';
                    }
                    const assignedChips = arr.map((name, idx) => `
                        <span class="chip">${name}
                            <button title="Retirer" onclick="removeAssignee('${slot.id}', ${idx}); event.stopPropagation();">&times;</button>
                        </span>
                    `).join(' ');

                    const selects = (arr.length < 2) ? `
                        <select class="member-select" onchange="assignSlot('${slot.id}', this.value); this.value='';" onclick="event.stopPropagation()">
                            <option value="">+ Ajouter une personne...</option>
                            ${members
                                .filter(m => !arr.includes(m))
                                .map(m => `<option value="${m}">${m}</option>`).join('')}
                        </select>
                    ` : `<em>Max 2 personnes</em>`;

                    const timeRange = `${slot.startDate.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})} - ${slot.endDate.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`;
                    return `
                        <div class="time-slot ${arr.length ? 'assigned' : ''}" onclick="clearSlot('${slot.id}')">
                            <div class="time-range">${timeRange}</div>
                            <div class="assigned-to">
                                ${assignedChips || '<span style="color:#6c757d">Aucun inscrit</span>'}
                                ${selects}
                            </div>
                        </div>
                    `;
                }).join('');

                dayDiv.innerHTML = dayHeader + `<div class="time-slots">${slotCards}</div>`;
                container.appendChild(dayDiv);
            });
            updateSummary();
        }

        function assignSlot(slotId, member) {
            if (!member) return;
            const arr = scheduleData[slotId] || [];
            if (arr.includes(member)) { showToast(member + ' est d√©j√† sur ce cr√©neau.'); return; }
            if (arr.length >= 2) { showToast('Ce cr√©neau a d√©j√† 2 personnes.'); return; }
            scheduleData[slotId] = [...arr, member];
            createSchedule();
            showToast('Ajout√© : ' + member);
        }

        function removeAssignee(slotId, index) {
            const arr = scheduleData[slotId] || [];
            arr.splice(index, 1);
            if (arr.length) scheduleData[slotId] = arr; else delete scheduleData[slotId];
            createSchedule();
            showToast('Personne retir√©e');
        }

        function clearSlot(slotId) {
            if (scheduleData[slotId]) {
                delete scheduleData[slotId];
                createSchedule();
                showToast('Cr√©neau remis √† z√©ro');
            }
        }

        // SUMMARY + EXPORTS
        function updateSummary() {
            document.getElementById('totalMembers').textContent = members.length;
            const tshirtsSelected = Object.values(tshirtData).filter(x => x).length;
            const slotsAssigned = Object.values(scheduleData).reduce((acc, arr) => acc + (arr?.length || 0), 0);
            document.getElementById('tshirtsSelected').textContent = tshirtsSelected;
            document.getElementById('slotsAssigned').textContent = slotsAssigned;
        }

        function exportTshirtData() {
            const data = members.map(member => ({ Membre: member, Taille: tshirtData[member] || 'Non s√©lectionn√©e' }));
            downloadCSV(data, 'tailles-tshirts-relais-vie.csv');
        }

        function exportScheduleData() {
            const entries = Object.entries(scheduleData);
            if (entries.length === 0) { alert('Aucune donn√©e √† exporter'); return; }
            const rows = [];
            entries.forEach(([slotId, assignees]) => {
                const startDate = new Date(Number(slotId));
                const endDate = new Date(startDate.getTime() + 30*60000);
                const dateLabel = startDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
                const timeRange = `${startDate.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})} - ${endDate.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`;
                (assignees || []).forEach(person => {
                    rows.push({ Date: dateLabel, Heure: timeRange, 'Membre assign√©': person });
                });
            });
            if (!rows.length) { alert('Aucune donn√©e √† exporter'); return; }
            downloadCSV(rows, 'planning-marche-relais-vie.csv');
        }

        function exportAllData() {
            const allData = { tshirts: tshirtData, schedule: scheduleData, members };
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'donnees-relais-vie-complete.json';
            link.click();
        }

        function downloadCSV(data, filename) {
            if (!data.length) { alert('Aucune donn√©e √† exporter'); return; }
            const headers = Object.keys(data[0]);
            const csv = [ headers.join(','), ...data.map(r => headers.map(h => `"${(r[h] ?? '').toString().replace(/"/g,'""')}"`).join(',')) ].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
        }

        // Netlify
        function prepareNetlifyPayload() {
            document.getElementById('tshirtDataField').value = JSON.stringify(tshirtData);
            document.getElementById('scheduleDataField').value = JSON.stringify(scheduleData);
            document.getElementById('membersField').value = JSON.stringify(members);
            const res = {
                totalMembers: members.length,
                tshirtsSelected: Object.values(tshirtData).filter(x => x).length,
                slotsAssigned: Object.values(scheduleData).reduce((acc, arr) => acc + (arr?.length || 0), 0)
            };
            document.getElementById('resume').value = JSON.stringify(res);
        }

        // Toast
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            clearTimeout(window.__toastTimer);
            window.__toastTimer = setTimeout(() => t.classList.remove('show'), 1800);
        }

        // boot
        initFilter();
        createTshirtGrid();
        createSchedule();
        updateSummary();
    </script>
  <script src="enhance-ui-v3.js?v=3"></script>
</body>
</html>
