<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lions Club - Relais pour la Vie - La Louvi√®re</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#5c4ee5;--bg2:#a146f0;--card:#fff;--text:#1b1f23;--muted:#667085;--primary:#ff7a18;--green:#17b26a;--red:#ef4444;
      --pill:#eef2ff;--pillText:#4338ca;--chip:#f1f5f9;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
      background: radial-gradient(1200px 800px at 80% -200px, #ffa057 0%, #ff7a18 40%, #ff4d4d 60%, #8b5cf6 100%), 
                  linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1000px;margin:28px auto;padding:0 16px}
    .header{
      color:#fff;border-radius:14px;padding:20px 20px 10px;background:linear-gradient(90deg,#ff7a18,#ff9f43);
      box-shadow:0 12px 30px rgba(0,0,0,.18);position:sticky;top:0;z-index:20
    }
    .title{font-size:30px;font-weight:800;text-shadow:0 1px 0 rgba(0,0,0,.08)}
    .subtitle{opacity:.95;margin-top:6px}
    .card{
      background:var(--card);border-radius:14px;margin-top:14px;box-shadow:0 10px 24px rgba(0,0,0,.12),0 2px 6px rgba(0,0,0,.06)
    }
    .tabs{display:flex;border-bottom:1px solid #eee;gap:6px;padding:0 10px}
    .tab{
      appearance:none;border:0;background:transparent;padding:14px 18px;margin:0;border-bottom:2px solid transparent;
      font-weight:600;color:#334155;cursor:pointer;display:flex;gap:10px;align-items:center
    }
    .tab.active{border-color:#ef4444;color:#111}
    .pad{padding:18px 22px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .slot-card{border:1px solid #e2e8f0;border-radius:12px;padding:14px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .label{font-size:12px;color:var(--muted)}
    .btn{
      appearance:none;border:0;cursor:pointer;border-radius:10px;padding:8px 12px;font-weight:600;background:#eef2ff;color:#3730a3
    }
    .btn.primary{background:#ef4444;color:#fff}
    .btn.ghost{background:#f1f5f9;color:#0f172a}
    .btn.small{padding:6px 10px;font-size:13px}
    select, .select{
      width:100%;padding:8px 10px;border:1px solid #e2e8f0;border-radius:10px;background:#fff
    }
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:6px 0 10px}
    .kpi{
      border:1px solid #e2e8f0;border-radius:12px;padding:14px;background:#fff;min-height:86px;
      display:flex;flex-direction:column;gap:8px;justify-content:center
    }
    .kpi .v{font-size:28px;font-weight:800}
    .kpi.link{cursor:pointer;transition:.15s transform}
    .kpi.link:hover{transform:translateY(-2px);box-shadow:0 10px 18px rgba(0,0,0,.08)}
    .section-title{display:flex;align-items:center;gap:8px;font-weight:700;margin:18px 0 10px}
    .pill{background:var(--pill);color:var(--pillText);font-weight:700;border-radius:999px;padding:4px 10px;font-size:12px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);padding:6px 10px;border-radius:999px;font-weight:600}
    .table{width:100%;border-collapse:collapse;border:1px solid #e2e8f0;border-radius:10px;overflow:hidden}
    .table th,.table td{padding:10px;border-bottom:1px solid #e2e8f0}
    .muted{color:var(--muted)}
    .success{color:var(--green)} .danger{color:var(--red)}
    .hint{font-size:13px;color:#475569}
    .divider{height:1px;background:#e2e8f0;margin:14px 0}
    .link{color:#2563eb;text-decoration:none;border-bottom:1px dotted #93c5fd}
    .center{display:flex;align-items:center;justify-content:center}
    @media (max-width:840px){.grid{grid-template-columns:1fr}.kpis{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">Lions Club-Relais pour la Vie-Parc de l'Arboretum-La Louvi√®re</div>
      <div class="subtitle">11‚Äì12 Octobre 2025</div>
    </div>

    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="tshirts">üß∫&nbsp;Tailles T-Shirts</button>
        <button class="tab" data-tab="planning">üóìÔ∏è&nbsp;Planning Marche</button>
        <button class="tab" data-tab="resume">üìä&nbsp;R√©sum√©</button>
      </div>

      <div id="content" class="pad"></div>
    </div>
  </div>

<script>
/** ========= CONFIG / HELPERS ========= */
const MEMBERS = [
  "Yvan D","Enora D","Pino D","Michelina C","Pasquale D","Malika Z","Olivier D","Nolann D","Aurore V",
  "Christophe G","Cyril G","Irina","Sabrina","Sandy","Le fils de Sandy","Yves E","Le fils de Manuela","Manuela"
, "Mario D", "Veronique L", "Sandy L"];

// slots 30 min: sam 15:00 -> dim 15:00
const start = new Date("2025-10-11T13:00:00Z"); // 15:00 local BE (UTC+2 en √©t√©) ‚âà 13:00Z
const end   = new Date("2025-10-12T13:00:00Z"); // 15:00 local
const SLOT_MIN = 30;

function fmtLocal(dt){
  return dt.toLocaleString('fr-BE',{weekday:'short', hour:'2-digit', minute:'2-digit'}).replace('.', '');
}
function slotIdFromDate(dt){
  const y=dt.getUTCFullYear(), m=String(dt.getUTCMonth()+1).padStart(2,'0'), d=String(dt.getUTCDate()).padStart(2,'0');
  const hh=String(dt.getUTCHours()).padStart(2,'0'), mm=String(dt.getUTCMinutes()).padStart(2,'0');
  return `slot-${y}-${m}-${d}-${hh}:${mm}`;
}
function addMin(dt, min){ return new Date(dt.getTime()+min*60000); }

// API helpers
async function apiGet(){ const r=await fetch('/api/state-get'); return r.json(); }
async function apiSetTshirt(name,size){
  await fetch('/api/state-set-tshirt',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({name, size})});
}
async function apiSetSlot(slotId,pos,name,remove=false){
  await fetch('/api/state-set-slot',{method:'POST',headers:{'content-type':'application/json'},
    body:JSON.stringify(remove?{slotId,pos,remove:true}:{slotId,pos,name})});
}

// state in memory
let state = { tshirtData:{}, scheduleData:{}, members:[] };

// tabs
const content = document.getElementById('content');
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    showTab(btn.dataset.tab);
  });
});

async function loadState(){
  const data = await apiGet();
  state = { tshirtData:data.tshirtData||{}, scheduleData:data.scheduleData||{}, members: data.members?.length? data.members: MEMBERS };
}
function showTab(key){
  if(key==='tshirts') renderTshirts();
  if(key==='planning') renderPlanning();
  if(key==='resume') renderResume();
}

/** ========= RENDER: T-SHIRTS ========= */
function renderTshirts(){
  const sizes = ['XS','S','M','L','XL','XXL'];
  const rows = MEMBERS.map(name=>{
    const val = state.tshirtData[name] || '';
    const hasSize = val && val !== ''; // V√©rifier si on a vraiment une taille
    const opts = ['<option value="">-- Choisir une taille --</option>']
      .concat(sizes.map(s=>`<option value="${s}" ${val===s?'selected':''}>${s}</option>`)).join('');
    const disabled = hasSize ? 'disabled' : '';
    const badge = hasSize ? `<span class="pill">${val}</span>` : '';
    return `
      <div class="slot-card">
        <div class="row" style="justify-content:space-between">
          <div><strong>${name}</strong></div>
          <div class="row">${badge}${hasSize?`<button class="btn small ghost" data-clear="${name}">Retirer</button>`:''}</div>
        </div>
        <div class="row" style="margin-top:10px">
          <select class="select" data-name="${name}" ${disabled}>
            ${opts}
          </select>
          ${!hasSize?`<span class="hint">La taille se sauvegarde automatiquement et se fige.</span>`:''}
        </div>
      </div>`;
  }).join('');

  content.innerHTML = `
    <h3 class="section-title">S√©lection des tailles de t-shirts</h3>
    <div class="grid">${rows}</div>
  `;

  
  // Admin buttons
  document.getElementById('btn-save-snap')?.addEventListener('click', saveSnapshot);
  document.getElementById('btn-restore-snap')?.addEventListener('click', ()=>{ if(confirm('Restaurer l\'√©tat sauvegard√© ? Cela √©crasera les r√©servations actuelles.')) restoreSnapshot(); });
  document.getElementById('btn-purge-out')?.addEventListener('click', ()=>{ if(confirm('Confirmer la purge des cr√©neaux hors plage ?')) adminPurgeOutOfRange(); });
  document.getElementById('btn-clear-visible')?.addEventListener('click', ()=>{ if(confirm('Remettre √† z√©ro TOUS les cr√©neaux visibles ?')) adminClearVisible(); });
// auto-save + freeze
  content.querySelectorAll('select[data-name]').forEach(sel=>{
    sel.addEventListener('change', async ()=>{
      const name = sel.dataset.name;
      const size = sel.value;
      if(!size) return;
      sel.disabled = true;
      await apiSetTshirt(name, size);
      await loadState();
      renderTshirts();
      
      // Redirection automatique vers l'onglet Planning apr√®s s√©lection d'une taille
      setTimeout(() => {
        // Switcher vers l'onglet Planning
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        document.querySelector('[data-tab="planning"]').classList.add('active');
        showTab('planning');
        
        // Scroll vers le haut du planning
        document.getElementById('content').scrollIntoView({behavior:'smooth', block:'start'});
      }, 200);
    });
  });
  // clear
  content.querySelectorAll('[data-clear]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if (btn.disabled) return; // √âviter les clics multiples
      
      const name = btn.dataset.clear;
      btn.disabled = true;
      btn.textContent = 'Suppression...';
      
      try {
        console.log('Envoi requ√™te de suppression pour:', name, 'avec size: null');
        await apiSetTshirt(name, null);
        console.log('Requ√™te API r√©ussie, rechargement de l\'√©tat...');
        await loadState();
        console.log('√âtat recharg√©, re-render...');
        renderTshirts();
        console.log('Re-render termin√©');
      } catch (error) {
        console.error('Erreur d√©taill√©e:', error);
        alert(`Erreur lors de la suppression: ${error.message}`);
        // Remettre le bouton en √©tat en cas d'erreur
        btn.disabled = false;
        btn.textContent = 'Retirer';
      }
    });
  });
}

/** ========= RENDER: PLANNING ========= */
function buildAllSlots(){
  const arr=[];
  for(let t = new Date(start); t<end; t = addMin(t, SLOT_MIN)){
    const id = slotIdFromDate(t);
    const endt = addMin(t,SLOT_MIN);
    arr.push({
      id, start: new Date(t), end: endt
    });
  }
  return arr;
}

function renderPlanning(){
  const all = buildAllSlots();
  const memberOpts = (selVal)=> ['<option value="">-- Choisir une personne --</option>']
    .concat(MEMBERS.map(n=>`<option value="${n}" ${selVal===n?'selected':''}>${n}</option>`)).join('');

  const rows = all.map(s=>{
    const slot = state.scheduleData[s.id] || { p1:null, p2:null };
    const occ = [slot.p1, slot.p2].filter(Boolean).join(', ') || '‚Äî';
    const full = slot.p1 && slot.p2;
    const free = 2 - [slot.p1,slot.p2].filter(Boolean).length;

    const sel1Disabled = !!slot.p1 ? 'disabled' : '';
    const sel2Disabled = !!slot.p2 ? 'disabled' : '';

    return `
      <div class="slot-card">
        <div class="row" style="justify-content:space-between">
          <div><strong>${fmtLocal(s.start)} ‚Üí ${fmtLocal(s.end)}</strong></div>
          <div class="muted">Occup√©:&nbsp;${occ}</div>
        </div>

        <div class="row" style="margin-top:8px;gap:14px">
          <div style="flex:1">
            <div class="label">Personne 1</div>
            ${slot.p1
              ? `<div class="row">
                    <span class="pill">${slot.p1}</span>
                    <button class="btn small ghost" data-remove data-id="${s.id}" data-pos="1">Retirer</button>
                  </div>`
              : `<select class="select" data-id="${s.id}" data-pos="1" ${sel1Disabled}>
                   ${memberOpts('')}
                 </select>
                 <div class="hint">Sauvegarde imm√©diate & fig√©e</div>`
            }
          </div>

          <div style="flex:1">
            <div class="label">Personne 2</div>
            ${slot.p2
              ? `<div class="row">
                    <span class="pill">${slot.p2}</span>
                    <button class="btn small ghost" data-remove data-id="${s.id}" data-pos="2">Retirer</button>
                  </div>`
              : `<select class="select" data-id="${s.id}" data-pos="2" ${sel2Disabled}>
                   ${memberOpts('')}
                 </select>
                 <div class="hint">Sauvegarde imm√©diate & fig√©e</div>`
            }
          </div>

          <div class="row">
            <span class="chip">${free} place(s) restante(s)</span>
            ${full?`<span class="chip">Complet</span>`:''}
          </div>
        </div>
      </div>
    `;
  }).join('');

  content.innerHTML = `
    <h3 class="section-title">R√©server un cr√©neau (jusqu'√† 2 personnes / cr√©neau)</h3>
    <p class="hint">Si un cr√©neau a d√©j√† 1 personne, une seconde peut se rajouter pour ne pas marcher seul¬∑e.</p>
    <div class="grid">${rows}</div>
  `;

  // auto-save + freeze on change
  content.querySelectorAll('select.select[data-id]').forEach(sel=>{
    sel.addEventListener('change', async ()=>{
      const slotId = sel.dataset.id;
      const pos = sel.dataset.pos === '1' ? 'p1' : 'p2'; // Convertir 1->p1, 2->p2
      const name = sel.value;
      if(!name) return;
      sel.disabled = true;
      await apiSetSlot(slotId, pos, name);
      await loadState();
      renderPlanning();
    });
  });
  // remove
  content.querySelectorAll('[data-remove]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const slotId = btn.dataset.id;
      const pos = btn.dataset.pos; // pos est d√©j√† "1" ou "2" dans le HTML
      const properPos = pos === '1' ? 'p1' : 'p2'; // Convertir pour l'API
      await apiSetSlot(slotId, properPos, null, true);
      await loadState();
      renderPlanning();
    });
  });
}

/** ========= RENDER: RESUME ========= */
function computeKpis(){
  const allMembers = state.members.length ? state.members : MEMBERS;
  const slots = buildAllSlots();

  let tshirtChosen = Object.values(state.tshirtData).filter(Boolean).length;

  // Compter uniquement les r√©servations dans les slots visibles
  let taken = slots.reduce((acc,s)=>{
    const occ = state.scheduleData[s.id]||{};
    return acc + (occ.p1?1:0) + (occ.p2?1:0);
  },0);

  const totalSlots = slots.length * 2;
  let available = totalSlots - taken;

  let noShirtNoSlot = allMembers.filter(n => {
    const hasTshirt = !!state.tshirtData[n];
    const hasSlot = slots.some(s => {
      const occ = state.scheduleData[s.id]||{};
      return occ.p1===n || occ.p2===n;
    });
    return !hasTshirt && !hasSlot;
  }).length;

  return { tshirtChosen, taken, available, noShirtNoSlot };
}

function renderResume(){
  const { tshirtChosen, taken, available, noShirtNoSlot } = computeKpis();

  showAdminIfAny();
// d√©tails t-shirts
  const rows = MEMBERS
    .filter(n=> state.tshirtData[n])
    .map(n=> `<tr><td>${n}</td><td>${state.tshirtData[n]}</td></tr>`).join('') || `<tr><td colspan="2" class="muted">‚Äî</td></tr>`;

  const counts = Object.values(state.tshirtData).filter(Boolean)
    .reduce((acc,s)=> (acc[s]=(acc[s]||0)+1, acc), {});
  const chips = Object.entries(counts).map(([k,v])=>`<span class="chip">${v}√ó ${k}</span>`).join('') || '<span class="muted">‚Äî</span>';

  // cr√©neaux pris / dispo
  const all = buildAllSlots();
  const takenChips = all.map(s=>{
    const occ = state.scheduleData[s.id];
    if(!occ?.p1 && !occ?.p2) return '';
    const p1 = occ.p1||'‚Äî', p2 = occ.p2||'‚Äî';
    return `<a class="chip" href="#slot-${s.start.toISOString()}">${fmtLocal(s.start)}</a>`;
  }).filter(Boolean).join('') || '<span class="muted">‚Äî</span>';

  const freeChips = all.map(s=>{
    const occ = state.scheduleData[s.id]||{};
    if(occ.p1 && occ.p2) return '';
    return `<a class="chip" href="#planning">${fmtLocal(s.start)}</a>`;
  }).filter(Boolean).join('') || '<span class="muted">‚Äî</span>';

  content.innerHTML = `
    <h3 class="section-title">R√©sum√© de l'organisation</h3>

    <div class="kpis">
      <div class="kpi link" id="kpi-incomplete" title="Aller aux d√©tails">
        <div class="row"><span class="pill">√Ä compl√©ter</span></div>
        <div class="v">${noShirtNoSlot}</div>
        <div class="muted">sans T-shirt & ni cr√©neau</div>
      </div>

      <div class="kpi link" id="kpi-shirts">
        <div class="row"><span class="pill">T-Shirts choisis</span></div>
        <div class="v">${tshirtChosen}</div>
      </div>

      <div class="kpi link" id="kpi-taken">
        <div class="row"><span class="pill">Cr√©neaux r√©serv√©s</span></div>
        <div class="v">${taken}</div>
      </div>

      <div class="kpi">
        <div class="row"><span class="pill" style="background:#ecfdf3;color:#065f46">Cr√©neaux dispo</span></div>
        <div class="v">${available}</div>
      </div>
    <div id="admin-panel" style="display:none"><div class="card" style="border:1px dashed #e2e8f0;background:#fafafa;margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="label">Outils admin (maintenance)</div>
        <div class="row" style="gap:8px">
          <button class="btn small ghost" id="btn-purge-out">Purger hors plage</button>
          <button class="btn small ghost" id="btn-clear-visible">Vider cr√©neaux visibles</button>
<button class="btn small" id="btn-save-snap">Sauvegarder √©tat</button>
<button class="btn small" id="btn-restore-snap">Restaurer √©tat</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <span class="muted">¬´¬†Purger hors plage¬†¬ª supprime les r√©servations qui ne sont pas dans la fen√™tre sam 15:00 ‚Üí dim 15:00. ¬´¬†Vider cr√©neaux visibles¬†¬ª remet √† z√©ro la fen√™tre visible.</span>
      </div>

    <div class="card" id="debug-card" style="background:#fffdf7;border:1px solid #facc15;margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row" style="gap:8px;align-items:center">
          <span>üõ†Ô∏è <strong>D√©tails des r√©servations (d√©bogage)</strong></span>
          <span class="label">Plage visible uniquement</span>
        </div>
        <button class="btn small" id="btn-refresh-debug">Actualiser</button>
      </div>
      <div class="row" style="margin-top:10px">
        <div id="debug-list" class="slot-card" style="width:100%">
          <div class="label">Liste des cr√©neaux pris ‚Äî p1 / p2</div>
          <div id="debug-container" class="row" style="gap:6px;flex-direction:column"></div>
        </div>
      </div>
    </div></div>

    <div class="row" style="gap:16px;margin:8px 0 2px">
    </div>

    <div class="divider"></div>

    <h4 class="section-title" id="section-shirts">üß∫ D√©tails T-Shirts par personne</h4>
    <table class="table">
      <thead><tr><th>Nom</th><th>Taille</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>

    <div class="row" style="margin:12px 0"><span class="label">R√©partition par tailles</span></div>
    <div class="chips">${chips}</div>

    <div class="divider"></div>

    <h4 class="section-title" id="section-slots">üîí Cr√©neaux d√©j√† pris</h4>
    <div class="chips">${takenChips}</div>

    <h4 class="section-title" style="margin-top:16px">‚úÖ Cr√©neaux disponibles</h4>
    <div class="chips">${freeChips}</div>
  `;

  // KPI anchors
  document.getElementById('kpi-shirts').onclick = ()=> document.getElementById('section-shirts')?.scrollIntoView({behavior:'smooth'});
  document.getElementById('kpi-taken').onclick  = ()=> document.getElementById('section-slots')?.scrollsIntoView({behavior:'smooth'});
  document.getElementById('kpi-incomplete').onclick = ()=> document.querySelector('[data-tab="tshirts"]').click();
  document.getElementById('btn-refresh-debug')?.addEventListener('click', renderDebugVisible);
  renderDebugVisible();
}



function isAdminEnabled(){
  try {
    const params = new URLSearchParams(location.search);
    if(params.get('admin') === '1') return true;
    return localStorage.getItem('admin') === '1';
  } catch(e){ return false; }
}
function showAdminIfAny(){
  const panel = document.getElementById('admin-panel');
  if(panel) panel.style.display = isAdminEnabled() ? '' : 'none';
}

async function adminPurgeOutOfRange(){
  const visibleIds = new Set(buildAllSlots().map(s=>s.id));
  const entries = Object.entries(state.scheduleData);
  for(const [slotId, occ] of entries){
    if(visibleIds.has(slotId)) continue;
    if(occ?.p1){ await apiSetSlot(slotId, 1, null, true); }
    if(occ?.p2){ await apiSetSlot(slotId, 2, null, true); }
  }
  await loadState();
  renderResume();
}


function renderDebugVisible(){
  const cont = document.getElementById('debug-container');
  if(!cont) return;
  cont.innerHTML='';
  const all = buildAllSlots();
  let found = 0;
  for(const s of all){
    const occ = state.scheduleData[s.id];
    if(!occ || (!occ.p1 && !occ.p2)) continue;
    found++;
    const row = document.createElement('div');
    row.className='row';
    row.style.justifyContent='space-between';
    row.style.border='1px solid #e5e7eb';
    row.style.borderRadius='10px';
    row.style.padding='8px 10px';
    row.innerHTML = `
      <div class="row" style="gap:10px">
        <span class="chip">${fmtLocal(s.start)}</span>
        <span class="chip">p1: ${occ.p1||'‚Äî'}</span>
        <span class="chip">p2: ${occ.p2||'‚Äî'}</span>
      </div>
      <div class="row" style="gap:6px">
        ${occ.p1 ? `<button class="btn small ghost" data-remove="1" data-id="${s.id}">Retirer p1</button>`:''}
        ${occ.p2 ? `<button class="btn small ghost" data-remove="2" data-id="${s.id}">Retirer p2</button>`:''}
      </div>
    `;
    cont.appendChild(row);
  }
  if(found===0){
    const empty = document.createElement('div');
    empty.className='label';
    empty.textContent='Aucune r√©servation dans cette plage.';
    cont.appendChild(empty);
  }

  // Wire removal buttons
  cont.querySelectorAll('[data-remove]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const pos = Number(btn.getAttribute('data-remove'));
      const id = btn.getAttribute('data-id');
      await apiSetSlot(id, pos, null, true);
      await loadState();
      renderResume();
    });
  });
}


function saveSnapshot(){
  try {
    const snap = JSON.stringify(state);
    localStorage.setItem('lionsclub_snapshot', snap);
    alert('√âtat sauvegard√© localement ‚úÖ');
  } catch(e){ alert('Impossible de sauvegarder : ' + e.message); }
}
async function restoreSnapshot(){
  try {
    const snap = localStorage.getItem('lionsclub_snapshot');
    if(!snap){ alert('Aucun snapshot trouv√©'); return; }
    const data = JSON.parse(snap);
    // Replay minimal operations to restore scheduleData (visible range + outside)
    // We clear all existing reservations first in both ranges
    const allVisible = new Set(buildAllSlots().map(s=>s.id));
    // Clear everything we currently have
    for (const [slotId, occ] of Object.entries(state.scheduleData||{})){
      if(occ?.p1) await apiSetSlot(slotId,1,null,true);
      if(occ?.p2) await apiSetSlot(slotId,2,null,true);
    }
    // Restore from snapshot
    for (const [slotId, occ] of Object.entries(data.scheduleData||{})){
      if(occ?.p1) await apiSetSlot(slotId,1,occ.p1,false);
      if(occ?.p2) await apiSetSlot(slotId,2,occ.p2,false);
    }
    // Restore tshirts
    for (const [name,size] of Object.entries(data.tshirtData||{})){
      if(size) await apiSetTshirt(name,size);
    }
    await loadState();
    renderResume();
    alert('√âtat restaur√© ‚úÖ');
  } catch(e){ alert('Restauration impossible : ' + e.message); }
}

async function adminClearVisible(){
  const ids = buildAllSlots().map(s=>s.id);
  for(const slotId of ids){
    const occ = state.scheduleData[slotId];
    if(!occ) continue;
    if(occ?.p1){ await apiSetSlot(slotId, 1, null, true); }
    if(occ?.p2){ await apiSetSlot(slotId, 2, null, true); }
  }
  await loadState();
  renderResume();
}

/** ========= INIT ========= */
(async function init(){
  await loadState();
  showTab('tshirts');
})();
</script>
</body>
</html>